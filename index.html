<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>‰∫ëËÅäÂ§© - CloudChat</title>
    <style>
        /* ============= ÂÖ®Â±ÄÊ†∑Âºè ============= */
        :root {
            --primary: #007AFF;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --info: #5AC8FA;
            --bg-primary: #F2F2F7;
            --bg-secondary: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #6C6C70;
            --border: #E5E5EA;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* ============= ÂêØÂä®Â±èÂπï ============= */
        .splash-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .splash-logo {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        .splash-title {
            font-size: 36px;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
        }

        .splash-subtitle {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        /* ============= ËÆ§ËØÅÈ°µÈù¢ ============= */
        .auth-page {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0051D5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        /* ============= ‰∏ªÂ∫îÁî®Â∏ÉÂ±Ä ============= */
        .app-container {
            display: flex;
            height: 100vh;
            height: 100dvh;
        }

        .sidebar {
            width: 70px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .sidebar-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 12px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .sidebar-icon:hover {
            background: var(--bg-primary);
        }

        .sidebar-icon.active {
            background: var(--primary);
            color: white;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .page-content {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* ============= ËÅäÂ§©È°µÈù¢ ============= */
        #chatPage {
            display: flex;
        }

        .contacts-panel {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .contacts-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box button {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .contact-item:hover {
            background: var(--bg-primary);
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 12px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .contact-message {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ============= ËÅäÂ§©Âå∫Âüü ============= */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .chat-header {
            height: 60px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
        }

        .chat-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            animation: messageIn 0.3s;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            max-width: 60%;
            margin: 0 12px;
        }

        .message.sent .message-content {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .message-bubble {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message.sent .message-bubble {
            background: var(--primary);
            color: white;
        }

        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            cursor: pointer;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ============= ËæìÂÖ•Âå∫Âüü ============= */
        .chat-input-area {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 15px;
        }

        .chat-input-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            position: relative;
        }

        .tool-btn {
            width: 36px;
            height: 36px;
            background: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: var(--border);
        }

        .emoji-picker {
            position: absolute;
            bottom: 50px;
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 10px;
            display: none;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            z-index: 100;
        }

        .emoji-picker.active {
            display: grid;
        }

        .emoji-item {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .emoji-item:hover {
            background: var(--bg-primary);
        }

        .chat-input-box {
            display: flex;
            gap: 10px;
        }

        .chat-input-box textarea {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
        }

        .send-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover {
            background: #0051D5;
        }

        /* ============= ÈÄöÁü• ============= */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            animation: slideIn 0.3s;
            max-width: 300px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.info {
            border-left: 4px solid var(--info);
        }

        /* ============= Â∑•ÂÖ∑Á±ª ============= */
        .hidden {
            display: none !important;
        }

        /* ============= ËßÜÈ¢ë/ËØ≠Èü≥ÈÄöËØùÊ†∑Âºè ============= */
        .call-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: none;
            flex-direction: column;
        }

        .call-overlay.active {
            display: flex;
        }

        .call-header {
            padding: 20px;
            text-align: center;
            color: white;
        }

        .call-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .call-status {
            font-size: 14px;
            opacity: 0.9;
        }

        .call-timer {
            font-size: 16px;
            font-weight: 600;
            margin-top: 8px;
        }

        .video-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .remote-video {
            width: 100%;
            max-width: 800px;
            height: auto;
            max-height: 70vh;
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.3);
            object-fit: cover;
        }

        .local-video {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 150px;
            height: 200px;
            border-radius: 16px;
            border: 3px solid white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            object-fit: cover;
            z-index: 10;
        }

        .voice-call-avatar {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: white;
        }

        .voice-call-avatar img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .voice-call-avatar h3 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .voice-call-avatar p {
            font-size: 16px;
            opacity: 0.9;
        }

        .audio-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: 30px;
        }

        .audio-bar {
            width: 4px;
            height: 20px;
            background: white;
            border-radius: 2px;
            animation: audioWave 1s infinite ease-in-out;
        }

        .audio-bar:nth-child(1) { animation-delay: 0s; }
        .audio-bar:nth-child(2) { animation-delay: 0.1s; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; }
        .audio-bar:nth-child(5) { animation-delay: 0.4s; }
        .audio-bar:nth-child(6) { animation-delay: 0.3s; }
        .audio-bar:nth-child(7) { animation-delay: 0.2s; }
        .audio-bar:nth-child(8) { animation-delay: 0.1s; }

        @keyframes audioWave {
            0%, 100% { height: 20px; }
            50% { height: 60px; }
        }

        .call-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 30px 20px;
            background: rgba(0, 0, 0, 0.2);
        }

        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .call-btn:active {
            transform: scale(0.95);
        }

        .call-btn.mute {
            background: white;
            color: #333;
        }

        .call-btn.mute.active {
            background: #FF3B30;
            color: white;
        }

        .call-btn.video {
            background: white;
            color: #333;
        }

        .call-btn.video.active {
            background: #FF3B30;
            color: white;
        }

        .call-btn.hangup {
            background: #FF3B30;
            color: white;
            width: 70px;
            height: 70px;
        }

        .call-btn.answer {
            background: #34C759;
            color: white;
            width: 70px;
            height: 70px;
        }

        .incoming-call {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 40px;
        }

        .incoming-call.active {
            display: flex;
        }

        .incoming-call-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            animation: pulse 2s infinite;
        }

        .incoming-call h2 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .incoming-call p {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 50px;
        }

        .incoming-call-actions {
            display: flex;
            gap: 30px;
        }

        .connecting-animation {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .connecting-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: connecting 1.4s infinite ease-in-out;
        }

        .connecting-dot:nth-child(1) { animation-delay: 0s; }
        .connecting-dot:nth-child(2) { animation-delay: 0.2s; }
        .connecting-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes connecting {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* ============= ÂìçÂ∫îÂºèËÆæËÆ° ============= */
        @media (max-width: 768px) {
            .contacts-panel {
                width: 100%;
            }

            .chat-area {
                display: none;
            }

            .chat-area.active {
                display: flex;
                position: fixed;
                inset: 0;
                z-index: 100;
            }

            .local-video {
                width: 100px;
                height: 133px;
                top: 20px;
                right: 20px;
            }

            .call-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .call-btn.hangup,
            .call-btn.answer {
                width: 60px;
                height: 60px;
            }

            .voice-call-avatar img {
                width: 120px;
                height: 120px;
            }

            .auth-container {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ÂêØÂä®Â±èÂπï -->
    <div class="splash-screen" id="splash">
        <div class="splash-logo">üí¨</div>
        <div class="splash-title">‰∫ëËÅäÂ§©</div>
        <div class="splash-subtitle">CloudChat</div>
    </div>

    <!-- ËÆ§ËØÅÈ°µÈù¢ -->
    <div class="auth-page" id="authPage">
        <div class="auth-container">
            <!-- ÁôªÂΩïË°®Âçï -->
            <form id="loginForm">
                <h2 style="margin-bottom: 30px; text-align: center;">Ê¨¢ËøéÂõûÊù•</h2>
                <div class="form-group">
                    <label>Ë¥¶Âè∑</label>
                    <input type="text" id="loginUsername" placeholder="ËØ∑ËæìÂÖ•Ë¥¶Âè∑" required>
                </div>
                <div class="form-group">
                    <label>ÂØÜÁ†Å</label>
                    <input type="password" id="loginPassword" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" required>
                </div>
                <button type="submit" class="btn btn-primary">ÁôªÂΩï</button>
                <p style="text-align: center; margin-top: 20px; color: var(--text-secondary);">
                    ËøòÊ≤°ÊúâË¥¶Âè∑Ôºü <a href="#" onclick="showRegister(); return false;" style="color: var(--primary);">Á´ãÂç≥Ê≥®ÂÜå</a>
                </p>
            </form>

            <!-- Ê≥®ÂÜåË°®Âçï -->
            <form id="registerForm" class="hidden">
                <h2 style="margin-bottom: 30px; text-align: center;">Ê≥®ÂÜåÊñ∞Ë¥¶Âè∑</h2>
                <div class="form-group">
                    <label>Â§¥ÂÉè</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img id="previewAvatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23ddd'/%3E%3Ctext x='50' y='50' font-size='40' text-anchor='middle' dy='.3em' fill='%23999'%3Eüë§%3C/text%3E%3C/svg%3E" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--border);">
                        <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-primary" style="width: auto; padding: 10px 20px;" onclick="document.getElementById('avatarInput').click()">ÈÄâÊã©Â§¥ÂÉè</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ë¥¶Âè∑</label>
                    <input type="text" id="registerUsername" placeholder="Â≠óÊØçÊàñÊï∞Â≠óÔºå4-20‰Ωç" required>
                </div>
                <div class="form-group">
                    <label>ÊòµÁß∞</label>
                    <input type="text" id="registerNickname" placeholder="ÊòæÁ§∫ÂêçÁß∞" required>
                </div>
                <div class="form-group">
                    <label>ÂØÜÁ†Å</label>
                    <input type="password" id="registerPassword" placeholder="Ëá≥Â∞ë6‰Ωç" required>
                </div>
                <button type="submit" class="btn btn-primary">Á´ãÂç≥Ê≥®ÂÜå</button>
                <p style="text-align: center; margin-top: 20px; color: var(--text-secondary);">
                    Â∑≤ÊúâË¥¶Âè∑Ôºü <a href="#" onclick="showLogin(); return false;" style="color: var(--primary);">ÂéªÁôªÂΩï</a>
                </p>
            </form>
        </div>
    </div>

    <!-- ‰∏ªÂ∫îÁî® -->
    <div class="app-container hidden" id="appContainer">
        <!-- ‰æßËæπÊ†è -->
        <div class="sidebar">
            <div class="user-avatar" style="margin-bottom: 20px;">
                <img id="sidebarAvatar" src="" alt="" style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer;" onclick="switchTab('settings')">
            </div>
            
            <div class="sidebar-icon active" onclick="switchTab('chat')" data-tab="chat">üí¨</div>
            <div class="sidebar-icon" onclick="switchTab('contacts')" data-tab="contacts">üë•</div>
            <div class="sidebar-icon" onclick="switchTab('moments')" data-tab="moments">üì±</div>
            <div class="sidebar-icon" onclick="switchTab('settings')" data-tab="settings" style="margin-top: auto;">‚öôÔ∏è</div>
        </div>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
        <div class="main-content">
            <!-- ËÅäÂ§©È°µÈù¢ -->
            <div id="chatPage" class="page-content">
                <!-- ËÅîÁ≥ª‰∫∫ÂàóË°® -->
                <div class="contacts-panel">
                    <div class="contacts-header">
                        <h3>Ê∂àÊÅØ</h3>
                        <div class="search-box">
                            <input type="text" id="searchContact" placeholder="ÊêúÁ¥¢Â•ΩÂèã">
                            <button onclick="showAddFriend()">‚ûï</button>
                        </div>
                    </div>
                    <div class="contacts-list" id="contactsList"></div>
                </div>

                               <!-- ËÅäÂ§©Âå∫Âüü -->
                <div class="chat-area">
                    <div class="chat-header">
                        <div class="chat-header-info">
                            <div class="chat-header-avatar">
                                <img id="chatAvatar" src="" alt="">
                            </div>
                            <div>
                                <div id="chatName" style="font-weight: 600;">ÈÄâÊã©‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫ÂºÄÂßãËÅäÂ§©</div>
                                <div id="chatStatus" style="font-size: 12px; color: var(--text-secondary);"></div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="tool-btn" onclick="startVideoCall()">üìπ</button>
                            <button class="tool-btn" onclick="startVoiceCall()">üìû</button>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                            ÈÄâÊã©‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫ÂºÄÂßãËÅäÂ§©
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <div class="chat-input-tools">
                            <button class="tool-btn" onclick="toggleEmojiPicker()">üòä</button>
                            <button class="tool-btn" onclick="document.getElementById('imageInput').click()">üñºÔ∏è</button>
                            <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="sendImage(this)">
                            
                            <div class="emoji-picker" id="emojiPicker">
                                <div class="emoji-item" onclick="insertEmoji('üòä')">üòä</div>
                                <div class="emoji-item" onclick="insertEmoji('üòÇ')">üòÇ</div>
                                <div class="emoji-item" onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</div>
                                <div class="emoji-item" onclick="insertEmoji('üëç')">üëç</div>
                                <div class="emoji-item" onclick="insertEmoji('üéâ')">üéâ</div>
                                <div class="emoji-item" onclick="insertEmoji('üíØ')">üíØ</div>
                                <div class="emoji-item" onclick="insertEmoji('üî•')">üî•</div>
                                <div class="emoji-item" onclick="insertEmoji('‚ú®')">‚ú®</div>
                                <div class="emoji-item" onclick="insertEmoji('üåü')">üåü</div>
                                <div class="emoji-item" onclick="insertEmoji('üí™')">üí™</div>
                                <div class="emoji-item" onclick="insertEmoji('üôè')">üôè</div>
                                <div class="emoji-item" onclick="insertEmoji('üòç')">üòç</div>
                            </div>
                        </div>

                        <div class="chat-input-box">
                            <textarea id="messageInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." onkeydown="handleEnter(event)"></textarea>
                            <button class="send-btn" onclick="sendMessage()">ÂèëÈÄÅ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ËÅîÁ≥ª‰∫∫È°µÈù¢ -->
            <div id="contactsPage" class="page-content hidden" style="padding: 20px; overflow-y: auto;">
                <h2 style="margin-bottom: 20px;">ËÅîÁ≥ª‰∫∫ÁÆ°ÁêÜ</h2>

                <!-- Ê∑ªÂä†Â•ΩÂèã -->
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Ê∑ªÂä†Â•ΩÂèã</h3>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="addFriendInput" placeholder="ËæìÂÖ•Â•ΩÂèãË¥¶Âè∑" style="flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px;">
                        <button onclick="sendFriendRequest()" class="btn btn-primary" style="width: auto; padding: 12px 24px;">Ê∑ªÂä†</button>
                    </div>
                </div>

                <!-- Â•ΩÂèãËØ∑Ê±Ç -->
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">
                        Â•ΩÂèãËØ∑Ê±Ç
                        <span id="requestBadge" class="hidden" style="background: var(--danger); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 8px;">0</span>
                    </h3>
                    <div id="friendRequestsList"></div>
                </div>

                <!-- Â•ΩÂèãÂàóË°® -->
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                    <h3 style="margin-bottom: 15px;">ÊàëÁöÑÂ•ΩÂèã</h3>
                    <div id="friendsList"></div>
                </div>
            </div>

            <!-- Âä®ÊÄÅÈ°µÈù¢ -->
            <div id="momentsPage" class="page-content hidden" style="overflow-y: auto;">
                <!-- ÂèëÂ∏ÉÂä®ÊÄÅ -->
                <div style="background: var(--bg-secondary); padding: 20px; border-bottom: 1px solid var(--border);">
                    <h3 style="margin-bottom: 15px;">ÂèëÂ∏ÉÂä®ÊÄÅ</h3>
                    <textarea id="momentText" placeholder="ÂàÜ‰∫´Êñ∞È≤ú‰∫ã..." style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; font-family: inherit; resize: vertical;"></textarea>
                    <div id="momentImagePreview" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;"></div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <input type="file" id="momentImageInput" accept="image/*" multiple style="display: none;" onchange="previewMomentImages(this)">
                        <button onclick="document.getElementById('momentImageInput').click()" class="tool-btn">üñºÔ∏è</button>
                        <button onclick="publishMoment()" class="btn btn-primary" style="width: auto; padding: 10px 24px;">ÂèëÂ∏É</button>
                    </div>
                </div>

                <!-- Âä®ÊÄÅÂàóË°® -->
                <div id="momentsList" style="padding: 20px;"></div>
            </div>

            <!-- ËÆæÁΩÆÈ°µÈù¢ -->
            <div id="settingsPage" class="page-content hidden" style="padding: 20px; overflow-y: auto;">
                <h2 style="margin-bottom: 20px;">ËÆæÁΩÆ</h2>

                <!-- ‰∏™‰∫∫‰ø°ÊÅØ -->
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 20px;">‰∏™‰∫∫‰ø°ÊÅØ</h3>
                    
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                        <img id="settingsAvatar" src="" alt="" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--border);">
                        <div style="flex: 1;">
                            <input type="file" id="changeAvatarInput" accept="image/*" style="display: none;" onchange="changeAvatar(this)">
                            <button onclick="document.getElementById('changeAvatarInput').click()" class="btn btn-primary" style="width: auto; padding: 10px 20px;">Êõ¥Êç¢Â§¥ÂÉè</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ÊòµÁß∞</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span id="settingsNickname" style="flex: 1; font-size: 16px;"></span>
                            <button onclick="changeNickname()" class="btn btn-primary" style="width: auto; padding: 8px 16px;">‰øÆÊîπ</button>
                        </div>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ë¥¶Âè∑</label>
                        <span id="settingsUsername" style="font-size: 16px; color: var(--text-secondary);"></span>
                    </div>
                </div>

                <!-- Â∫îÁî®ËÆæÁΩÆ -->
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 20px;">Â∫îÁî®ËÆæÁΩÆ</h3>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span>Ê∂àÊÅØÊèêÁ§∫Èü≥</span>
                        <label style="position: relative; display: inline-block; width: 50px; height: 26px;">
                            <input type="checkbox" id="soundToggle" checked style="opacity: 0; width: 0; height: 0;">
                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 26px; display: block;"></span>
                            <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; display: block;"></span>
                        </label>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Ê∑±Ëâ≤Ê®°Âºè</span>
                        <label style="position: relative; display: inline-block; width: 50px; height: 26px;">
                            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()" style="opacity: 0; width: 0; height: 0;">
                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 26px; display: block;"></span>
                            <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; display: block;"></span>
                        </label>
                    </div>
                </div>

                <!-- ÂÖ≥‰∫é -->
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">ÂÖ≥‰∫é</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6;">
                        ‰∫ëËÅäÂ§© v1.0<br>
                        ‰∏Ä‰∏™ÊîØÊåÅËßÜÈ¢ë/ËØ≠Èü≥ÈÄöËØùÁöÑÁé∞‰ª£ÂåñËÅäÂ§©Â∫îÁî®<br>
                        Âü∫‰∫é IndexedDB Êú¨Âú∞Â≠òÂÇ®
                    </p>
                </div>

                <!-- ÈÄÄÂá∫ÁôªÂΩï -->
                <button onclick="logout()" class="btn" style="background: var(--danger); color: white; width: 100%;">ÈÄÄÂá∫ÁôªÂΩï</button>
            </div>
        </div>
    </div>

    <!-- ËßÜÈ¢ë/ËØ≠Èü≥ÈÄöËØùÁïåÈù¢ -->
    <div class="call-overlay" id="callOverlay">
        <div class="call-header">
            <h2 id="callContactName">ÈÄöËØù‰∏≠...</h2>
            <div class="call-status" id="callStatus">Ê≠£Âú®ËøûÊé•...</div>
            <div class="call-timer" id="callTimer">00:00</div>
        </div>

        <div class="video-container" id="videoContainer">
            <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
            <video id="localVideo" class="local-video" autoplay playsinline muted></video>
            
            <div class="voice-call-avatar hidden" id="voiceCallAvatar">
                <img id="voiceAvatar" src="" alt="">
                <h3 id="voiceName"></h3>
                <p id="voiceStatus">Ê≠£Âú®ÈÄöËØù‰∏≠...</p>
                <div class="audio-visualizer">
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                </div>
            </div>
        </div>

        <div class="call-controls">
            <button class="call-btn mute" id="muteBtn" onclick="toggleMute()">üé§</button>
            <button class="call-btn hangup" onclick="endCall()">üìû</button>
            <button class="call-btn video" id="videoBtn" onclick="toggleVideo()">üìπ</button>
        </div>
    </div>

    <!-- Êù•ÁîµÁïåÈù¢ -->
    <div class="incoming-call" id="incomingCall">
        <img id="incomingAvatar" class="incoming-call-avatar" src="" alt="">
        <h2 id="incomingName"></h2>
        <p id="incomingType">ËßÜÈ¢ëÈÄöËØù...</p>
        <div class="connecting-animation">
            <div class="connecting-dot"></div>
            <div class="connecting-dot"></div>
            <div class="connecting-dot"></div>
        </div>
        <div class="incoming-call-actions">
            <button class="call-btn hangup" onclick="rejectCall()">‚ùå</button>
            <button class="call-btn answer" onclick="acceptCall()">‚úÖ</button>
        </div>
    </div>

    <script>
        // ============= ÂÖ®Â±ÄÂèòÈáè =============
        let db;
        let currentUser = null;
        let currentChat = null;
        let momentImages = [];

        // ============= IndexedDB ÂàùÂßãÂåñ =============
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('CloudChatDB', 1);

                request.onerror = () => {
                    console.error('IndexedDBÊâìÂºÄÂ§±Ë¥•Ôºå‰ΩøÁî®localStorageÂ§áÁî®');
                    resolve(null);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('IndexedDBÂàùÂßãÂåñÊàêÂäü');
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;

                    if (!db.objectStoreNames.contains('users')) {
                        const userStore = db.createObjectStore('users', { keyPath: 'username' });
                        userStore.createIndex('username', 'username', { unique: true });
                    }

                    if (!db.objectStoreNames.contains('messages')) {
                        const messageStore = db.createObjectStore('messages', { keyPath: 'id', autoIncrement: true });
                        messageStore.createIndex('chatId', 'chatId', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('friends')) {
                        const friendStore = db.createObjectStore('friends', { keyPath: 'id', autoIncrement: true });
                        friendStore.createIndex('userId', 'userId', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('friendRequests')) {
                        const requestStore = db.createObjectStore('friendRequests', { keyPath: 'id', autoIncrement: true });
                        requestStore.createIndex('toUser', 'toUser', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('moments')) {
                        const momentStore = db.createObjectStore('moments', { keyPath: 'id', autoIncrement: true });
                        momentStore.createIndex('userId', 'userId', { unique: false });
                    }
                };
            });
        }

        // ============= Â∫îÁî®ÂàùÂßãÂåñ =============
        window.onload = async function() {
            await initDB();

            setTimeout(() => {
                document.getElementById('splash').classList.add('hidden');
            }, 2000);

            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            }

            setupEventListeners();
        };

        function setupEventListeners() {
            document.getElementById('loginForm').onsubmit = handleLogin;
            document.getElementById('registerForm').onsubmit = handleRegister;
            document.getElementById('avatarInput').onchange = previewAvatar;
            document.getElementById('searchContact').oninput = (e) => filterContacts(e.target.value);

            const soundToggle = document.getElementById('soundToggle');
            soundToggle.checked = localStorage.getItem('soundEnabled') !== 'false';
        }

        // ============= ËÆ§ËØÅÂäüËÉΩ =============
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function handleLogin(e) {
            e.preventDefault();

            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!db) {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const user = users.find(u => u.username === username && u.password === password);

                if (user) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showApp();
                } else {
                    showNotification('Ë¥¶Âè∑ÊàñÂØÜÁ†ÅÈîôËØØ', 'error');
                }
                return;
            }

            const transaction = db.transaction(['users'], 'readonly');
            const store = transaction.objectStore('users');
            const request = store.get(username);

            request.onsuccess = function() {
                const user = request.result;
                if (user && user.password === password) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showApp();
                } else {
                    showNotification('Ë¥¶Âè∑ÊàñÂØÜÁ†ÅÈîôËØØ', 'error');
                }
            };
        }

        function handleRegister(e) {
            e.preventDefault();

            const username = document.getElementById('registerUsername').value.trim();
            const nickname = document.getElementById('registerNickname').value.trim();
            const password = document.getElementById('registerPassword').value;
            const avatar = document.getElementById('previewAvatar').src;

            if (!/^[a-zA-Z0-9]{4,20}$/.test(username)) {
                showNotification('Ë¥¶Âè∑Ê†ºÂºè‰∏çÊ≠£Á°Æ', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('ÂØÜÁ†ÅËá≥Â∞ë6‰Ωç', 'error');
                return;
            }

            const user = { username, nickname, password, avatar, createdAt: new Date().toISOString() };

            if (!db) {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                if (users.some(u => u.username === username)) {
                    showNotification('Ë¥¶Âè∑Â∑≤Â≠òÂú®', 'error');
                    return;
                }
                users.push(user);
                localStorage.setItem('users', JSON.stringify(users));
                showNotification('Ê≥®ÂÜåÊàêÂäü', 'success');
                showLogin();
                return;
            }

            const transaction = db.transaction(['users'], 'readwrite');
            const store = transaction.objectStore('users');
            const request = store.add(user);

            request.onsuccess = function() {
                showNotification('Ê≥®ÂÜåÊàêÂäü', 'success');
                showLogin();
            };

            request.onerror = function() {
                showNotification('Ë¥¶Âè∑Â∑≤Â≠òÂú®', 'error');
            };
        }

        function previewAvatar(input) {
            if (!input.files || !input.files[0]) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                compressImage(e.target.result, function(compressed) {
                    document.getElementById('previewAvatar').src = compressed;
                });
            };
            reader.readAsDataURL(input.files[0]);
        }

        function showApp() {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            
            document.getElementById('sidebarAvatar').src = currentUser.avatar;
            document.getElementById('settingsAvatar').src = currentUser.avatar;
            document.getElementById('settingsNickname').textContent = currentUser.nickname;
            document.getElementById('settingsUsername').textContent = currentUser.username;

            loadContacts();
            loadFriendRequests();
            loadFriends();
            loadMoments();
        }

        function logout() {
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
                localStorage.removeItem('currentUser');
                location.reload();
            }
        }

        // ============= Ê†áÁ≠æÂàáÊç¢ =============
        function switchTab(tab) {
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('hidden');
            });

            document.querySelectorAll('.sidebar-icon').forEach(icon => {
                icon.classList.remove('active');
            });

            document.getElementById(tab + 'Page').classList.remove('hidden');
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

            if (tab === 'contacts') {
                loadFriendRequests();
                loadFriends();
            } else if (tab === 'moments') {
                loadMoments();
            } else if (tab === 'chat') {
                loadContacts();
            }
        }

               // ============= ËÅîÁ≥ª‰∫∫ÂäüËÉΩ =============
        function loadContacts() {
            if (!db) {
                document.getElementById('contactsList').innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">ÊöÇÊó†ËÅîÁ≥ª‰∫∫</div>';
                return;
            }

            const transaction = db.transaction(['friends', 'users'], 'readonly');
            const friendStore = transaction.objectStore('friends');
            const userStore = transaction.objectStore('users');
            const index = friendStore.index('userId');
            const request = index.getAll(currentUser.username);

            request.onsuccess = function() {
                const friends = request.result;
                const contactsList = document.getElementById('contactsList');
                contactsList.innerHTML = '';

                if (friends.length === 0) {
                    contactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">ÊöÇÊó†ËÅîÁ≥ª‰∫∫<br>ÂéªÊ∑ªÂä†Â•ΩÂèãÂêßÔºÅ</div>';
                    return;
                }

                friends.forEach(friend => {
                    const friendUsername = friend.friendId;
                    const userRequest = userStore.get(friendUsername);

                    userRequest.onsuccess = function() {
                        const user = userRequest.result;
                        if (user) {
                            const contactItem = createContactItem(user);
                            contactsList.appendChild(contactItem);
                        }
                    };
                });
            };
        }

        function createContactItem(user) {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.onclick = () => openChat(user);

            div.innerHTML = `
                <div class="contact-avatar">
                    <img src="${user.avatar}" alt="${user.nickname}">
                </div>
                <div class="contact-info">
                    <div class="contact-name">${user.nickname}</div>
                    <div class="contact-message">ÁÇπÂáªÂºÄÂßãËÅäÂ§©</div>
                </div>
            `;

            return div;
        }

        function filterContacts(searchText) {
            const items = document.querySelectorAll('.contact-item');
            items.forEach(item => {
                const name = item.querySelector('.contact-name').textContent;
                if (name.toLowerCase().includes(searchText.toLowerCase())) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function showAddFriend() {
            switchTab('contacts');
            document.getElementById('addFriendInput').focus();
        }

        function sendFriendRequest() {
            const friendUsername = document.getElementById('addFriendInput').value.trim();

            if (!friendUsername) {
                showNotification('ËØ∑ËæìÂÖ•Â•ΩÂèãË¥¶Âè∑', 'error');
                return;
            }

            if (friendUsername === currentUser.username) {
                showNotification('‰∏çËÉΩÊ∑ªÂä†Ëá™Â∑±‰∏∫Â•ΩÂèã', 'error');
                return;
            }

            if (!db) {
                showNotification('ÂäüËÉΩÊöÇ‰∏çÂèØÁî®', 'error');
                return;
            }

            const transaction = db.transaction(['users', 'friends', 'friendRequests'], 'readwrite');
            const userStore = transaction.objectStore('users');
            const friendStore = transaction.objectStore('friends');
            const requestStore = transaction.objectStore('friendRequests');

            const userRequest = userStore.get(friendUsername);

            userRequest.onsuccess = function() {
                if (!userRequest.result) {
                    showNotification('Áî®Êà∑‰∏çÂ≠òÂú®', 'error');
                    return;
                }

                const friendIndex = friendStore.index('userId');
                const checkFriend = friendIndex.getAll(currentUser.username);

                checkFriend.onsuccess = function() {
                    const isFriend = checkFriend.result.some(f => f.friendId === friendUsername);
                    if (isFriend) {
                        showNotification('Â∑≤ÁªèÊòØÂ•ΩÂèã‰∫Ü', 'info');
                        return;
                    }

                    const request = {
                        fromUser: currentUser.username,
                        fromNickname: currentUser.nickname,
                        fromAvatar: currentUser.avatar,
                        toUser: friendUsername,
                        status: 'pending',
                        timestamp: new Date().toISOString()
                    };

                    requestStore.add(request);

                    transaction.oncomplete = function() {
                        showNotification('Â•ΩÂèãËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅ', 'success');
                        document.getElementById('addFriendInput').value = '';
                    };
                };
            };
        }

        function loadFriendRequests() {
            if (!db) return;

            const transaction = db.transaction(['friendRequests'], 'readonly');
            const store = transaction.objectStore('friendRequests');
            const index = store.index('toUser');
            const request = index.getAll(currentUser.username);

            request.onsuccess = function() {
                const requests = request.result.filter(r => r.status === 'pending');
                const requestsList = document.getElementById('friendRequestsList');
                const badge = document.getElementById('requestBadge');

                if (requests.length === 0) {
                    requestsList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">ÊöÇÊó†Â•ΩÂèãËØ∑Ê±Ç</p>';
                    badge.classList.add('hidden');
                    return;
                }

                badge.textContent = requests.length;
                badge.classList.remove('hidden');

                requestsList.innerHTML = '';
                requests.forEach(req => {
                    const div = document.createElement('div');
                    div.style.cssText = 'display: flex; align-items: center; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px;';

                    div.innerHTML = `
                        <img src="${req.fromAvatar}" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${req.fromNickname}</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">@${req.fromUser}</div>
                        </div>
                        <button onclick="acceptFriend(${req.id})" style="padding: 8px 16px; background: var(--success); color: white; border: none; border-radius: 6px; margin-right: 8px; cursor: pointer;">Êé•Âèó</button>
                        <button onclick="rejectFriend(${req.id})" style="padding: 8px 16px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer;">ÊãíÁªù</button>
                    `;

                    requestsList.appendChild(div);
                });
            };
        }

        function acceptFriend(requestId) {
            const transaction = db.transaction(['friendRequests', 'friends'], 'readwrite');
            const requestStore = transaction.objectStore('friendRequests');
            const friendStore = transaction.objectStore('friends');

            const getRequest = requestStore.get(requestId);

            getRequest.onsuccess = function() {
                const request = getRequest.result;

                friendStore.add({
                    userId: currentUser.username,
                    friendId: request.fromUser,
                    addedAt: new Date().toISOString()
                });

                friendStore.add({
                    userId: request.fromUser,
                    friendId: currentUser.username,
                    addedAt: new Date().toISOString()
                });

                request.status = 'accepted';
                requestStore.put(request);

                transaction.oncomplete = function() {
                    showNotification('Â∑≤Ê∑ªÂä†Â•ΩÂèã', 'success');
                    loadFriendRequests();
                    loadFriends();
                    loadContacts();
                };
            };
        }

        function rejectFriend(requestId) {
            const transaction = db.transaction(['friendRequests'], 'readwrite');
            const store = transaction.objectStore('friendRequests');

            const getRequest = store.get(requestId);

            getRequest.onsuccess = function() {
                const request = getRequest.result;
                request.status = 'rejected';
                store.put(request);

                transaction.oncomplete = function() {
                    showNotification('Â∑≤ÊãíÁªù', 'info');
                    loadFriendRequests();
                };
            };
        }

        function loadFriends() {
            if (!db) return;

            const transaction = db.transaction(['friends', 'users'], 'readonly');
            const friendStore = transaction.objectStore('friends');
            const userStore = transaction.objectStore('users');
            const index = friendStore.index('userId');
            const request = index.getAll(currentUser.username);

            request.onsuccess = function() {
                const friends = request.result;
                const friendsList = document.getElementById('friendsList');
                friendsList.innerHTML = '';

                if (friends.length === 0) {
                    friendsList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">ËøòÊ≤°ÊúâÂ•ΩÂèã</p>';
                    return;
                }

                friends.forEach(friend => {
                    const userRequest = userStore.get(friend.friendId);

                    userRequest.onsuccess = function() {
                        const user = userRequest.result;
                        if (user) {
                            const div = document.createElement('div');
                            div.style.cssText = 'display: flex; align-items: center; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px;';

                            div.innerHTML = `
                                <img src="${user.avatar}" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">${user.nickname}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">@${user.username}</div>
                                </div>
                                <button onclick="openChatFromContacts('${user.username}')" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">ÂèëÊ∂àÊÅØ</button>
                            `;

                            friendsList.appendChild(div);
                        }
                    };
                });
            };
        }

        function openChatFromContacts(username) {
            const transaction = db.transaction(['users'], 'readonly');
            const store = transaction.objectStore('users');
            const request = store.get(username);

            request.onsuccess = function() {
                if (request.result) {
                    switchTab('chat');
                    openChat(request.result);
                }
            };
        }

        // ============= ËÅäÂ§©ÂäüËÉΩ =============
        function openChat(user) {
            currentChat = user;

            document.getElementById('chatAvatar').src = user.avatar;
            document.getElementById('chatName').textContent = user.nickname;
            document.getElementById('chatStatus').textContent = '@' + user.username;

            loadMessages();

            if (window.innerWidth <= 768) {
                document.querySelector('.chat-area').classList.add('active');
            }
        }

        function loadMessages() {
            if (!currentChat || !db) {
                document.getElementById('chatMessages').innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">ÈÄâÊã©‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫ÂºÄÂßãËÅäÂ§©</div>';
                return;
            }

            const chatId = [currentUser.username, currentChat.username].sort().join('_');

            const transaction = db.transaction(['messages'], 'readonly');
            const store = transaction.objectStore('messages');
            const index = store.index('chatId');
            const request = index.getAll(chatId);

            request.onsuccess = function() {
                const messages = request.result.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';

                if (messages.length === 0) {
                    messagesContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">ËøòÊ≤°ÊúâÊ∂àÊÅØÔºåÂºÄÂßãËÅäÂ§©ÂêßÔºÅ</div>';
                    return;
                }

                messages.forEach(msg => {
                    const messageEl = createMessageElement(msg);
                    messagesContainer.appendChild(messageEl);
                });

                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };
        }

        function createMessageElement(msg) {
            const div = document.createElement('div');
            div.className = 'message' + (msg.senderId === currentUser.username ? ' sent' : '');

            const avatar = msg.senderId === currentUser.username ? currentUser.avatar : currentChat.avatar;
            const time = formatTime(msg.timestamp);

            if (msg.type === 'image') {
                div.innerHTML = `
                    <div class="message-avatar">
                        <img src="${avatar}" alt="">
                    </div>
                    <div class="message-content">
                        <img src="${msg.content}" class="message-image" onclick="viewImage('${msg.content}')">
                        <div class="message-time">${time}</div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="message-avatar">
                        <img src="${avatar}" alt="">
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">${escapeHtml(msg.content)}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            }

            return div;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content || !currentChat) return;

            const message = {
                chatId: [currentUser.username, currentChat.username].sort().join('_'),
                senderId: currentUser.username,
                receiverId: currentChat.username,
                type: 'text',
                content: content,
                timestamp: new Date().toISOString(),
                read: false
            };

            if (!db) {
                showNotification('ÂèëÈÄÅÂ§±Ë¥•', 'error');
                return;
            }

            const transaction = db.transaction(['messages'], 'readwrite');
            const store = transaction.objectStore('messages');
            store.add(message);

            transaction.oncomplete = function() {
                input.value = '';
                loadMessages();
                playSound();
            };
        }

        function sendImage(input) {
            if (!input.files || !input.files[0] || !currentChat) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                compressImage(e.target.result, function(compressed) {
                    const message = {
                        chatId: [currentUser.username, currentChat.username].sort().join('_'),
                        senderId: currentUser.username,
                        receiverId: currentChat.username,
                        type: 'image',
                        content: compressed,
                        timestamp: new Date().toISOString(),
                        read: false
                    };

                    const transaction = db.transaction(['messages'], 'readwrite');
                    const store = transaction.objectStore('messages');
                    store.add(message);

                    transaction.oncomplete = function() {
                        input.value = '';
                        loadMessages();
                        playSound();
                    };
                });
            };
            reader.readAsDataURL(input.files[0]);
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('active');
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
            toggleEmojiPicker();
        }

        function viewImage(src) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; cursor: pointer;';
            overlay.onclick = () => overlay.remove();

            const img = document.createElement('img');
            img.src = src;
            img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';

            overlay.appendChild(img);
            document.body.appendChild(overlay);
        }

        // ============= Âä®ÊÄÅÂäüËÉΩ =============
        function previewMomentImages(input) {
            if (!input.files) return;

            momentImages = [];
            const preview = document.getElementById('momentImagePreview');
            preview.innerHTML = '';

            Array.from(input.files).slice(0, 9).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    compressImage(e.target.result, function(compressed) {
                        momentImages.push(compressed);

                        const div = document.createElement('div');
                        div.style.cssText = 'position: relative; width: 80px; height: 80px;';
                        
                        const img = document.createElement('img');
                        img.src = compressed;
                        img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: 8px;';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = '√ó';
                        removeBtn.style.cssText = 'position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background: var(--danger); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 14px; line-height: 1;';
                        removeBtn.onclick = () => {
                            momentImages.splice(index, 1);
                            div.remove();
                        };

                        div.appendChild(img);
                        div.appendChild(removeBtn);
                        preview.appendChild(div);
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        function publishMoment() {
            const text = document.getElementById('momentText').value.trim();

            if (!text && momentImages.length === 0) {
                showNotification('ËØ∑ËæìÂÖ•ÂÜÖÂÆπÊàñÈÄâÊã©ÂõæÁâá', 'error');
                return;
            }

            if (!db) {
                showNotification('ÂèëÂ∏ÉÂ§±Ë¥•', 'error');
                return;
            }

            const moment = {
                userId: currentUser.username,
                userNickname: currentUser.nickname,
                userAvatar: currentUser.avatar,
                content: text,
                images: [...momentImages],
                likes: [],
                comments: [],
                timestamp: new Date().toISOString()
            };

            const transaction = db.transaction(['moments'], 'readwrite');
            const store = transaction.objectStore('moments');
            store.add(moment);

            transaction.oncomplete = function() {
                showNotification('ÂèëÂ∏ÉÊàêÂäü', 'success');
                document.getElementById('momentText').value = '';
                document.getElementById('momentImagePreview').innerHTML = '';
                document.getElementById('momentImageInput').value = '';
                momentImages = [];
                loadMoments();
            };
        }

        function loadMoments() {
            if (!db) return;

            const transaction = db.transaction(['moments'], 'readonly');
            const store = transaction.objectStore('moments');
            const request = store.getAll();

            request.onsuccess = function() {
                const moments = request.result.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                const momentsList = document.getElementById('momentsList');
                momentsList.innerHTML = '';

                if (moments.length === 0) {
                    momentsList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">ËøòÊ≤°ÊúâÂä®ÊÄÅ</div>';
                    return;
                }

                moments.forEach(moment => {
                    const div = createMomentElement(moment);
                    momentsList.appendChild(div);
                });
            };
        }

        function createMomentElement(moment) {
            const div = document.createElement('div');
            div.style.cssText = 'background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 15px;';

            const isLiked = moment.likes && moment.likes.includes(currentUser.username);
            const likeCount = moment.likes ? moment.likes.length : 0;

            let imagesHtml = '';
            if (moment.images && moment.images.length > 0) {
                const gridCols = moment.images.length === 1 ? 1 : moment.images.length <= 4 ? 2 : 3;
                imagesHtml = `
                    <div style="display: grid; grid-template-columns: repeat(${gridCols}, 1fr); gap: 10px; margin-top: 15px;">
                        ${moment.images.map(img => `
                            <img src="${img}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; cursor: pointer;" onclick="viewImage('${img}')">
                        `).join('')}
                    </div>
                `;
            }

            div.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <img src="${moment.userAvatar}" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${moment.userNickname}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${formatTime(moment.timestamp)}</div>
                    </div>
                </div>
                <div style="line-height: 1.6;">${escapeHtml(moment.content)}</div>
                ${imagesHtml}
                <div style="display: flex; gap: 20px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                    <button onclick="toggleLike(${moment.id})" style="background: none; border: none; font-size: 14px; color: ${isLiked ? 'var(--danger)' : 'var(--text-secondary)'}; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${likeCount > 0 ? likeCount : ''}
                    </button>
                    <button style="background: none; border: none; font-size: 14px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        üí¨ ${moment.comments ? moment.comments.length : 0}
                    </button>
                </div>
            `;

            return div;
        }

        function toggleLike(momentId) {
            const transaction = db.transaction(['moments'], 'readwrite');
            const store = transaction.objectStore('moments');
            const request = store.get(momentId);

            request.onsuccess = function() {
                const moment = request.result;
                if (!moment.likes) moment.likes = [];

                const index = moment.likes.indexOf(currentUser.username);
                if (index > -1) {
                    moment.likes.splice(index, 1);
                } else {
                    moment.likes.push(currentUser.username);
                }

                store.put(moment);

                transaction.oncomplete = function() {
                    loadMoments();
                };
            };
        }

        // ============= ËÆæÁΩÆÂäüËÉΩ =============
        function changeAvatar(input) {
            if (!input.files || !input.files[0]) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                compressImage(e.target.result, function(compressed) {
                    currentUser.avatar = compressed;

                    const transaction = db.transaction(['users'], 'readwrite');
                    const store = transaction.objectStore('users');
                    store.put(currentUser);

                    transaction.oncomplete = function() {
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        document.getElementById('settingsAvatar').src = compressed;
                        document.getElementById('sidebarAvatar').src = compressed;
                        showNotification('Â§¥ÂÉèÂ∑≤Êõ¥Êñ∞', 'success');
                    };
                });
            };
            reader.readAsDataURL(input.files[0]);
        }

        function changeNickname() {
            const newNickname = prompt('ËæìÂÖ•Êñ∞ÊòµÁß∞:', currentUser.nickname);
            if (!newNickname || newNickname === currentUser.nickname) return;

            currentUser.nickname = newNickname.trim();

            const transaction = db.transaction(['users'], 'readwrite');
            const store = transaction.objectStore('users');
            store.put(currentUser);

            transaction.oncomplete = function() {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('settingsNickname').textContent = newNickname;
                showNotification('ÊòµÁß∞Â∑≤Êõ¥Êñ∞', 'success');
            };
        }

        function toggleDarkMode() {
            showNotification('Ê∑±Ëâ≤Ê®°ÂºèÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
        }

              // ============= ËßÜÈ¢ë/ËØ≠Èü≥ÈÄöËØùÂäüËÉΩ =============
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let callType = null;
        let callTimer = null;
        let callStartTime = null;
        let isMuted = false;
        let isVideoOff = false;
        let currentCallUser = null;
        let incomingCallData = null;

        const iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };

        async function startVideoCall() {
            if (!currentChat) {
                showNotification('ËØ∑ÂÖàÈÄâÊã©ËÅîÁ≥ª‰∫∫', 'error');
                return;
            }

            callType = 'video';
            currentCallUser = currentChat;
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('localVideo').classList.remove('hidden');
                document.getElementById('remoteVideo').classList.remove('hidden');
                document.getElementById('voiceCallAvatar').classList.add('hidden');

                showCallOverlay();
                sendCallRequest('video');

                // Ê®°ÊãüÂØπÊñπÊé•Âê¨ÔºàÂÆûÈôÖÂ∫îÁî®‰∏≠Â∫îÈÄöËøáWebRTC‰ø°‰ª§ÊúçÂä°Âô®Ôºâ
                setTimeout(() => {
                    simulateCallAnswer();
                }, 2000);

            } catch (error) {
                console.error('Ëé∑ÂèñÂ™í‰ΩìÂ§±Ë¥•:', error);
                if (error.name === 'NotAllowedError') {
                    showNotification('ËØ∑ÂÖÅËÆ∏ËÆøÈóÆÊëÑÂÉèÂ§¥ÂíåÈ∫¶ÂÖãÈ£é', 'error');
                } else if (error.name === 'NotFoundError') {
                    showNotification('Êú™ÊâæÂà∞ÊëÑÂÉèÂ§¥ÊàñÈ∫¶ÂÖãÈ£éËÆæÂ§á', 'error');
                } else {
                    showNotification('Êó†Ê≥ïÂêØÂä®ËßÜÈ¢ëÈÄöËØù: ' + error.message, 'error');
                }
            }
        }

        async function startVoiceCall() {
            if (!currentChat) {
                showNotification('ËØ∑ÂÖàÈÄâÊã©ËÅîÁ≥ª‰∫∫', 'error');
                return;
            }

            callType = 'audio';
            currentCallUser = currentChat;

            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: false,
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                document.getElementById('localVideo').classList.add('hidden');
                document.getElementById('remoteVideo').classList.add('hidden');
                document.getElementById('voiceCallAvatar').classList.remove('hidden');
                document.getElementById('voiceAvatar').src = currentChat.avatar;
                document.getElementById('voiceName').textContent = currentChat.nickname;
                document.getElementById('voiceStatus').textContent = 'Ê≠£Âú®ÂëºÂè´...';
                document.getElementById('videoBtn').style.display = 'none';

                showCallOverlay();
                sendCallRequest('audio');

                setTimeout(() => {
                    simulateCallAnswer();
                }, 2000);

            } catch (error) {
                console.error('Ëé∑ÂèñÈü≥È¢ëÂ§±Ë¥•:', error);
                if (error.name === 'NotAllowedError') {
                    showNotification('ËØ∑ÂÖÅËÆ∏ËÆøÈóÆÈ∫¶ÂÖãÈ£é', 'error');
                } else {
                    showNotification('Êó†Ê≥ïÂêØÂä®ËØ≠Èü≥ÈÄöËØù: ' + error.message, 'error');
                }
            }
        }

        function showCallOverlay() {
            document.getElementById('callOverlay').classList.add('active');
            document.getElementById('callContactName').textContent = currentCallUser.nickname;
            document.getElementById('callStatus').textContent = 'Ê≠£Âú®ÂëºÂè´...';
            document.getElementById('callTimer').textContent = '00:00';
            resetCallControls();

            if (callType === 'audio') {
                document.getElementById('videoBtn').style.display = 'none';
            } else {
                document.getElementById('videoBtn').style.display = 'block';
            }
        }

        function sendCallRequest(type) {
            const callRequest = {
                type: 'call_request',
                callType: type,
                from: currentUser.username,
                fromNickname: currentUser.nickname,
                fromAvatar: currentUser.avatar,
                to: currentCallUser.username,
                timestamp: Date.now()
            };

            console.log('Â∑≤ÂèëÈÄÅÈÄöËØùËØ∑Ê±Ç:', callRequest);
            // ÂÆûÈôÖÂ∫îÁî®‰∏≠Â∫îÈÄöËøáWebSocketÊàñ‰ø°‰ª§ÊúçÂä°Âô®ÂèëÈÄÅ
        }

        function simulateCallAnswer() {
            document.getElementById('callStatus').textContent = 'Â∑≤Êé•ÈÄö';
            if (callType === 'audio') {
                document.getElementById('voiceStatus').textContent = 'ÈÄöËØù‰∏≠...';
            }
            startCallTimer();
            
            // Ê®°ÊãüËøúÁ®ãËßÜÈ¢ëÊµÅÔºàÂÆûÈôÖÂ∫îÁî®‰∏≠Êù•Ëá™WebRTCÔºâ
            if (callType === 'video') {
                simulateRemoteVideo();
            }
            
            showNotification('ÈÄöËØùÂ∑≤Êé•ÈÄöÔºàÊºîÁ§∫Ê®°ÂºèÔºâ', 'success');
        }

        function simulateRemoteVideo() {
            // Âú®ÊºîÁ§∫Ê®°Âºè‰∏≠ÔºåÊàë‰ª¨ÂèØ‰ª•ÈïúÂÉèÊú¨Âú∞ËßÜÈ¢ë‰Ωú‰∏∫ËøúÁ®ãËßÜÈ¢ë
            const remoteVideo = document.getElementById('remoteVideo');
            
            // ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑMediaStream‰Ωú‰∏∫Ê®°ÊãüÁöÑËøúÁ®ãÊµÅ
            navigator.mediaDevices.getUserMedia({
                video: { width: 1280, height: 720 },
                audio: false
            }).then(stream => {
                remoteVideo.srcObject = stream;
                remoteStream = stream;
            }).catch(err => {
                console.log('Êó†Ê≥ïÊ®°ÊãüËøúÁ®ãËßÜÈ¢ë:', err);
            });
        }

        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('callTimer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        function toggleMute() {
            if (!localStream) return;

            isMuted = !isMuted;
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !isMuted;
            }

            const muteBtn = document.getElementById('muteBtn');
            if (isMuted) {
                muteBtn.classList.add('active');
                muteBtn.textContent = 'üîá';
            } else {
                muteBtn.classList.remove('active');
                muteBtn.textContent = 'üé§';
            }
        }

        function toggleVideo() {
            if (!localStream || callType === 'audio') return;

            isVideoOff = !isVideoOff;
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !isVideoOff;
            }

            const videoBtn = document.getElementById('videoBtn');
            const localVideo = document.getElementById('localVideo');
            
            if (isVideoOff) {
                videoBtn.classList.add('active');
                videoBtn.textContent = 'üì∑';
                localVideo.style.display = 'none';
            } else {
                videoBtn.classList.remove('active');
                videoBtn.textContent = 'üìπ';
                localVideo.style.display = 'block';
            }
        }

        function endCall() {
            // ÂÅúÊ≠¢ÊâÄÊúâÂ™í‰ΩìËΩ®ÈÅì
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }

            // Ê∏ÖÈô§ÂÆöÊó∂Âô®
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }

            // ÂÖ≥Èó≠PeerConnection
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            // ÈöêËóèÈÄöËØùÁïåÈù¢
            document.getElementById('callOverlay').classList.remove('active');
            document.getElementById('incomingCall').classList.remove('active');

            // Ê∏ÖÈô§ËßÜÈ¢ëÂÖÉÁ¥†
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;

            // ÈáçÁΩÆÁä∂ÊÄÅ
            resetCallControls();
            currentCallUser = null;
            callType = null;

            showNotification('ÈÄöËØùÂ∑≤ÁªìÊùü', 'info');
        }

        function resetCallControls() {
            isMuted = false;
            isVideoOff = false;

            const muteBtn = document.getElementById('muteBtn');
            const videoBtn = document.getElementById('videoBtn');

            muteBtn.classList.remove('active');
            muteBtn.textContent = 'üé§';

            videoBtn.classList.remove('active');
            videoBtn.textContent = 'üìπ';
        }

        // ============= Êù•ÁîµÂ§ÑÁêÜ =============
        function showIncomingCall(callData) {
            incomingCallData = callData;
            
            document.getElementById('incomingAvatar').src = callData.fromAvatar;
            document.getElementById('incomingName').textContent = callData.fromNickname;
            document.getElementById('incomingType').textContent = 
                callData.callType === 'video' ? 'ËßÜÈ¢ëÈÄöËØù...' : 'ËØ≠Èü≥ÈÄöËØù...';
            
            document.getElementById('incomingCall').classList.add('active');
            
            // Êí≠ÊîæÊù•ÁîµÈìÉÂ£∞
            playRingtone();
        }

        async function acceptCall() {
            if (!incomingCallData) return;

            document.getElementById('incomingCall').classList.remove('active');
            stopRingtone();

            callType = incomingCallData.callType;
            currentCallUser = {
                username: incomingCallData.from,
                nickname: incomingCallData.fromNickname,
                avatar: incomingCallData.fromAvatar
            };

            try {
                const constraints = {
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                };

                if (callType === 'video') {
                    constraints.video = {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    };
                }

                localStream = await navigator.mediaDevices.getUserMedia(constraints);

                if (callType === 'video') {
                    document.getElementById('localVideo').srcObject = localStream;
                    document.getElementById('localVideo').classList.remove('hidden');
                    document.getElementById('remoteVideo').classList.remove('hidden');
                    document.getElementById('voiceCallAvatar').classList.add('hidden');
                } else {
                    document.getElementById('localVideo').classList.add('hidden');
                    document.getElementById('remoteVideo').classList.add('hidden');
                    document.getElementById('voiceCallAvatar').classList.remove('hidden');
                    document.getElementById('voiceAvatar').src = currentCallUser.avatar;
                    document.getElementById('voiceName').textContent = currentCallUser.nickname;
                    document.getElementById('videoBtn').style.display = 'none';
                }

                showCallOverlay();
                document.getElementById('callStatus').textContent = 'Â∑≤Êé•ÈÄö';
                startCallTimer();

                if (callType === 'video') {
                    simulateRemoteVideo();
                }

            } catch (error) {
                console.error('Êé•Âê¨Â§±Ë¥•:', error);
                showNotification('Êó†Ê≥ïÊé•Âê¨ÈÄöËØù', 'error');
                rejectCall();
            }
        }

        function rejectCall() {
            stopRingtone();
            document.getElementById('incomingCall').classList.remove('active');
            incomingCallData = null;
            showNotification('Â∑≤ÊãíÁªùÈÄöËØù', 'info');
        }

        // ============= ÈìÉÂ£∞ÂäüËÉΩ =============
        let ringtoneAudio = null;

        function playRingtone() {
            // ÂàõÂª∫ÁÆÄÂçïÁöÑÈìÉÂ£∞ÔºàÂÆûÈôÖÂ∫îÁî®‰∏≠Â∫î‰ΩøÁî®Èü≥È¢ëÊñá‰ª∂Ôºâ
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 440;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.3;

                oscillator.start();

                ringtoneAudio = { oscillator, audioContext };

                // Ëá™Âä®ÂÅúÊ≠¢
                setTimeout(() => {
                    if (ringtoneAudio) {
                        stopRingtone();
                    }
                }, 30000);
            } catch (e) {
                console.log('Êó†Ê≥ïÊí≠ÊîæÈìÉÂ£∞:', e);
            }
        }

        function stopRingtone() {
            if (ringtoneAudio) {
                try {
                    ringtoneAudio.oscillator.stop();
                    ringtoneAudio.audioContext.close();
                } catch (e) {
                    console.log('ÂÅúÊ≠¢ÈìÉÂ£∞Êó∂Âá∫Èîô:', e);
                }
                ringtoneAudio = null;
            }
        }

        // ============= Â∑•ÂÖ∑ÂáΩÊï∞ =============
        function compressImage(dataUrl, callback, maxWidth = 800) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                callback(canvas.toDataURL('image/jpeg', 0.8));
            };
            img.src = dataUrl;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) {
                return 'ÂàöÂàö';
            } else if (diff < 3600000) {
                return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
            } else if (diff < 86400000) {
                return Math.floor(diff / 3600000) + 'Â∞èÊó∂Ââç';
            } else if (diff < 604800000) {
                return Math.floor(diff / 86400000) + 'Â§©Ââç';
            } else {
                return `${date.getMonth() + 1}Êúà${date.getDate()}Êó•`;
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function playSound() {
            if (localStorage.getItem('soundEnabled') === 'false') return;

            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.1;

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);

                setTimeout(() => {
                    audioContext.close();
                }, 200);
            } catch (e) {
                console.log('Êó†Ê≥ïÊí≠ÊîæÊèêÁ§∫Èü≥');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">
                        ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}
                    </span>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ============= ÈîÆÁõòÂø´Êç∑ÈîÆ =============
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + K: ÊêúÁ¥¢
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchContact').focus();
            }

            // Esc: ÂÖ≥Èó≠ÈÄöËØù
            if (e.key === 'Escape') {
                const callOverlay = document.getElementById('callOverlay');
                const incomingCall = document.getElementById('incomingCall');
                
                if (callOverlay.classList.contains('active')) {
                    endCall();
                } else if (incomingCall.classList.contains('active')) {
                    rejectCall();
                }
            }

            // Ctrl/Cmd + M: ÈùôÈü≥
            if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
                e.preventDefault();
                const callOverlay = document.getElementById('callOverlay');
                if (callOverlay.classList.contains('active')) {
                    toggleMute();
                }
            }

            // Ctrl/Cmd + E: ËßÜÈ¢ëÂºÄÂÖ≥
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                const callOverlay = document.getElementById('callOverlay');
                if (callOverlay.classList.contains('active') && callType === 'video') {
                    toggleVideo();
                }
            }
        });

        // ============= ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠Ë°®ÊÉÖÈÄâÊã©Âô® =============
        document.addEventListener('click', function(e) {
            const emojiPicker = document.getElementById('emojiPicker');
            const emojiBtn = document.querySelector('[onclick="toggleEmojiPicker()"]');
            
            if (emojiPicker && !emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                emojiPicker.classList.remove('active');
            }
        });

        // ============= ÂÆöÊúüÊ£ÄÊü•Êù•Áîµ (ÊºîÁ§∫Áî®) =============
        // Âú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÂ∫îËØ•ÈÄöËøáWebSocketÂÆûÊó∂Êé®ÈÄÅ
        setInterval(() => {
            const calls = JSON.parse(localStorage.getItem('activeCalls') || '[]');
            const myIncomingCalls = calls.filter(call => 
                call.to === currentUser?.username && 
                call.type === 'call_request' &&
                Date.now() - call.timestamp < 30000 // 30ÁßíÂÜÖÁöÑÂëºÂè´
            );

            if (myIncomingCalls.length > 0 && !document.getElementById('incomingCall').classList.contains('active')) {
                showIncomingCall(myIncomingCalls[0]);
            }
        }, 2000);

        // ============= È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ =============
        window.addEventListener('beforeunload', function() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
        });

        // ============= È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÂ§ÑÁêÜ =============
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('È°µÈù¢ÈöêËóè');
            } else {
                console.log('È°µÈù¢ÊòæÁ§∫');
                // Âà∑Êñ∞Êï∞ÊçÆ
                if (currentUser) {
                    loadContacts();
                    loadFriendRequests();
                }
            }
        });

        // ============= Ë∞ÉËØï‰ø°ÊÅØ =============
        console.log('üéâ ‰∫ëËÅäÂ§©Á≥ªÁªüÂ∑≤Âä†ËΩΩ');
        console.log('üì± ÊîØÊåÅÂäüËÉΩ:');
        console.log('   ‚úÖ ÊñáÂ≠óËÅäÂ§©');
        console.log('   ‚úÖ ÂõæÁâáÂèëÈÄÅ');
        console.log('   ‚úÖ Â•ΩÂèãÁÆ°ÁêÜ');
        console.log('   ‚úÖ Âä®ÊÄÅÂèëÂ∏É');
        console.log('   ‚úÖ ËßÜÈ¢ëÈÄöËØùÔºàÊºîÁ§∫Ê®°ÂºèÔºâ');
        console.log('   ‚úÖ ËØ≠Èü≥ÈÄöËØùÔºàÊºîÁ§∫Ê®°ÂºèÔºâ');
        console.log('');
        console.log('‚å®Ô∏è  Âø´Êç∑ÈîÆ:');
        console.log('   Ctrl/Cmd + K: ÊêúÁ¥¢');
        console.log('   Ctrl/Cmd + M: ÈùôÈü≥/ÂèñÊ∂àÈùôÈü≥');
        console.log('   Ctrl/Cmd + E: ÂºÄÂÖ≥ËßÜÈ¢ë');
        console.log('   Esc: ÁªìÊùüÈÄöËØù');
    </script>
</body>
</html>

