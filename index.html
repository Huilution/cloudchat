<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudChat - äº‘ç«¯ç¤¾äº¤å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --dark: #2d3748;
            --light: #f7fafc;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .theme-light {
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border: #e2e8f0;
        }

        .theme-dark {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border: #4a5568;
        }

        /* ç™»å½•/æ³¨å†Œé¡µé¢ */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: var(--primary);
            font-size: 32px;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: #718096;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .avatar-upload {
            text-align: center;
            margin-bottom: 20px;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid var(--primary);
            position: relative;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-preview:hover::after {
            content: 'æ›´æ¢å¤´åƒ';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }

        /* ä¸»åº”ç”¨ç•Œé¢ */
        .app-container {
            display: none;
            height: 100vh;
            background: var(--bg-secondary);
        }

        .app-container.active {
            display: flex;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 80px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
        }

        .sidebar-icon {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .sidebar-icon:hover {
            background: var(--bg-secondary);
            transform: scale(1.1);
        }

        .sidebar-icon.active {
            background: var(--gradient);
            color: white;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 20px;
            cursor: pointer;
            border: 3px solid var(--primary);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* è”ç³»äººåˆ—è¡¨ */
        .contacts-panel {
            width: 320px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .contacts-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .contacts-header h2 {
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .search-box button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .contact-item:hover {
            background: var(--bg-secondary);
        }

        .contact-item.active {
            background: var(--bg-secondary);
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 15px;
            position: relative;
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .contact-message {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
        }

        .chat-header {
            padding: 20px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
        }

        .chat-header-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 15px;
        }

        .chat-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-actions button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            margin-left: 15px;
            color: var(--text-primary);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            animation: messageIn 0.3s ease;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 10px;
        }

        .message.sent .message-avatar {
            margin-right: 0;
            margin-left: 10px;
            order: 2;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            max-width: 60%;
        }

        .message-bubble {
            padding: 12px 18px;
            border-radius: 18px;
            margin-bottom: 5px;
            word-wrap: break-word;
        }

        .message.received .message-bubble {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .message.sent .message-bubble {
            background: var(--gradient);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-image {
            max-width: 300px;
            border-radius: 12px;
            cursor: pointer;
        }

        .message-time {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 0 5px;
        }

        .chat-input-area {
            padding: 20px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
        }

        .chat-input-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background: var(--bg-secondary);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }

        .tool-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .chat-input-box {
            display: flex;
            gap: 10px;
        }

        .chat-input-box textarea {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .send-btn {
            padding: 0 30px;
            border: none;
            border-radius: 10px;
            background: var(--gradient);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* åŠ¨æ€é¡µé¢ */
        .moments-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .moments-header {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .publish-moment {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .publish-moment textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            resize: none;
            min-height: 100px;
            font-family: inherit;
            margin-bottom: 15px;
        }

        .moment-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .moment-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .moment-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 15px;
        }

        .moment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .moment-content {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .moment-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .moment-images img {
            width: 100%;
            border-radius: 10px;
            cursor: pointer;
        }

        .moment-actions {
            display: flex;
            gap: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .moment-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .moment-action-btn:hover {
            color: var(--primary);
        }

        /* è®¾ç½®é¡µé¢ */
        .settings-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .settings-section {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* å¥½å‹è¯·æ±‚ */
        .friend-request {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .friend-request-info {
            display: flex;
            align-items: center;
        }

        .friend-request-actions {
            display: flex;
            gap: 10px;
        }

        .btn-accept {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-reject {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-primary);
        }

        /* è§†é¢‘é€šè¯ */
        .video-call-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .video-call-container.active {
            display: flex;
        }

        .video-streams {
            flex: 1;
            position: relative;
        }

        .remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border-radius: 10px;
            object-fit: cover;
            border: 3px solid white;
        }

        .video-controls {
            padding: 20px;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .video-control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-end-call {
            background: var(--danger);
            color: white;
        }

        .btn-mute {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }

            .contacts-panel {
                width: 100%;
                position: absolute;
                z-index: 10;
                display: none;
            }

            .contacts-panel.active {
                display: flex;
            }

            .local-video {
                width: 120px;
                height: 90px;
            }
        }

        /* Emojié€‰æ‹©å™¨ */
        .emoji-picker {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            display: none;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            max-width: 320px;
        }

        .emoji-picker.active {
            display: grid;
        }

        .emoji-item {
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .emoji-item:hover {
            background: var(--bg-secondary);
            transform: scale(1.2);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }

        /* é€šçŸ¥æç¤º */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-primary);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
            }
            to {
                transform: translateX(0);
            }
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.info {
            border-left: 4px solid var(--primary);
        }
    </style>
</head>
<body class="theme-light">

    <!-- ç™»å½•/æ³¨å†Œé¡µé¢ -->
    <div id="authPage" class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <h1>â˜ï¸ CloudChat</h1>
                <p>è¿æ¥ä¸–ç•Œï¼Œåˆ†äº«ç”Ÿæ´»</p>
            </div>

            <!-- ç™»å½•è¡¨å• -->
            <form id="loginForm">
                <div class="form-group">
                    <label>è´¦å·</label>
                    <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥è´¦å·" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="btn btn-primary">ç™»å½•</button>
                <button type="button" class="btn btn-secondary" onclick="showRegister()">æ³¨å†Œæ–°è´¦å·</button>
            </form>

            <!-- æ³¨å†Œè¡¨å• -->
            <form id="registerForm" class="hidden">
                <div class="avatar-upload">
                    <div class="avatar-preview" onclick="document.getElementById('avatarInput').click()">
                        <img id="avatarPreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Ctext x='50%25' y='50%25' font-size='40' text-anchor='middle' dy='.3em'%3EğŸ‘¤%3C/text%3E%3C/svg%3E" alt="å¤´åƒ">
                    </div>
                    <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="previewAvatar(this)">
                </div>
                <div class="form-group">
                    <label>è´¦å·</label>
                    <input type="text" id="registerUsername" placeholder="è¯·è¾“å…¥è´¦å·ï¼ˆä¸å¯é‡å¤ï¼‰" required>
                </div>
                <div class="form-group">
                    <label>æ˜µç§°</label>
                    <input type="text" id="registerNickname" placeholder="è¯·è¾“å…¥æ˜µç§°" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="btn btn-primary">æ³¨å†Œ</button>
                <button type="button" class="btn btn-secondary" onclick="showLogin()">å·²æœ‰è´¦å·ï¼Œå»ç™»å½•</button>
            </form>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="appPage" class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="user-avatar" onclick="showTab('profile')">
                <img id="sidebarAvatar" src="" alt="å¤´åƒ">
            </div>
            
            <div class="sidebar-icon active" onclick="showTab('chat')" title="èŠå¤©">
                ğŸ’¬
            </div>
            
            <div class="sidebar-icon" onclick="showTab('moments')" title="åŠ¨æ€">
                ğŸ“±
            </div>
            
            <div class="sidebar-icon" onclick="showTab('friends')" title="å¥½å‹">
                ğŸ‘¥
            </div>
            
            <div class="sidebar-icon" onclick="showTab('settings')" title="è®¾ç½®">
                âš™ï¸
            </div>

            <div style="margin-top: auto;">
                <div class="sidebar-icon" onclick="logout()" title="é€€å‡º">
                    ğŸšª
                </div>
            </div>
        </div>
        <!-- è”ç³»äººåˆ—è¡¨ -->
        <div class="contacts-panel" id="contactsPanel">
            <div class="contacts-header">
                <h2>æ¶ˆæ¯</h2>
                <div class="search-box">
                    <input type="text" id="searchUser" placeholder="æœç´¢è´¦å·æ·»åŠ å¥½å‹">
                    <button onclick="searchAndAddFriend()">â•</button>
                </div>
            </div>
            <div class="contacts-list" id="contactsList">
                <!-- è”ç³»äººåˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="chat-area" id="chatArea">
            <div class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-header-avatar">
                        <img id="chatAvatar" src="" alt="">
                    </div>
                    <div>
                        <h3 id="chatName">é€‰æ‹©ä¸€ä¸ªè”ç³»äººå¼€å§‹èŠå¤©</h3>
                        <p id="chatStatus" style="font-size: 12px; color: var(--text-secondary);"></p>
                    </div>
                </div>
                <div class="chat-actions">
                    <button onclick="startVideoCall()" title="è§†é¢‘é€šè¯">ğŸ“¹</button>
                    <button onclick="startVoiceCall()" title="è¯­éŸ³é€šè¯">ğŸ“</button>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                    é€‰æ‹©å·¦ä¾§è”ç³»äººå¼€å§‹èŠå¤©
                </div>
            </div>

            <div class="chat-input-area">
                <div class="chat-input-tools">
                    <button class="tool-btn" onclick="toggleEmojiPicker()" title="è¡¨æƒ…">ğŸ˜Š</button>
                    <button class="tool-btn" onclick="document.getElementById('imageInput').click()" title="å›¾ç‰‡">ğŸ–¼ï¸</button>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="sendImage(this)">
                    
                    <!-- Emojié€‰æ‹©å™¨ -->
                    <div class="emoji-picker" id="emojiPicker">
                        <span class="emoji-item" onclick="insertEmoji('ğŸ˜€')">ğŸ˜€</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ˜')">ğŸ˜</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ¥°')">ğŸ¥°</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ˜')">ğŸ˜</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ¤”')">ğŸ¤”</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ˜­')">ğŸ˜­</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ˜¡')">ğŸ˜¡</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ‘')">ğŸ‘</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ‘')">ğŸ‘</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ™')">ğŸ™</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ’ª')">ğŸ’ª</span>
                        <span class="emoji-item" onclick="insertEmoji('â¤ï¸')">â¤ï¸</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ’”')">ğŸ’”</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ”¥')">ğŸ”¥</span>
                        <span class="emoji-item" onclick="insertEmoji('âœ¨')">âœ¨</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ‰')">ğŸ‰</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸŠ')">ğŸŠ</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ')">ğŸ</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸŒ¹')">ğŸŒ¹</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸŒ¸')">ğŸŒ¸</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸŒˆ')">ğŸŒˆ</span>
                        <span class="emoji-item" onclick="insertEmoji('â­')">â­</span>
                        <span class="emoji-item" onclick="insertEmoji('ğŸ’«')">ğŸ’«</span>
                    </div>
                </div>
                <div class="chat-input-box">
                    <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="3" onkeypress="handleEnter(event)"></textarea>
                    <button class="send-btn" onclick="sendMessage()">å‘é€</button>
                </div>
            </div>
        </div>

        <!-- åŠ¨æ€é¡µé¢ -->
        <div class="moments-container hidden" id="momentsPage">
            <div class="moments-header">
                <h1>ğŸ“± æœ‹å‹åœˆ</h1>
                <p>åˆ†äº«ç”Ÿæ´»ï¼Œè®°å½•ç²¾å½©ç¬é—´</p>
            </div>

            <div class="publish-moment">
                <textarea id="momentText" placeholder="åˆ†äº«æ–°é²œäº‹..." rows="4"></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="tool-btn" onclick="document.getElementById('momentImageInput').click()">ğŸ–¼ï¸ æ·»åŠ å›¾ç‰‡</button>
                    <input type="file" id="momentImageInput" accept="image/*" multiple style="display: none;" onchange="previewMomentImages(this)">
                    <button class="btn btn-primary" style="width: auto; padding: 10px 30px;" onclick="publishMoment()">å‘å¸ƒ</button>
                </div>
                <div id="momentImagePreview" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;"></div>
            </div>

            <div id="momentsList">
                <!-- åŠ¨æ€åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å¥½å‹é¡µé¢ -->
        <div class="settings-container hidden" id="friendsPage">
            <div class="settings-section">
                <h3>ğŸ‘¥ å¥½å‹è¯·æ±‚</h3>
                <div id="friendRequestsList">
                    <p style="text-align: center; color: var(--text-secondary); padding: 20px;">æš‚æ— æ–°çš„å¥½å‹è¯·æ±‚</p>
                </div>
            </div>

            <div class="settings-section">
                <h3>ğŸ“‹ æˆ‘çš„å¥½å‹</h3>
                <div id="myFriendsList">
                    <!-- å¥½å‹åˆ—è¡¨ -->
                </div>
            </div>
        </div>

        <!-- è®¾ç½®é¡µé¢ -->
        <div class="settings-container hidden" id="settingsPage">
            <div class="settings-section">
                <h3>ğŸ‘¤ ä¸ªäººä¿¡æ¯</h3>
                <div class="setting-item">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 5px;">å¤´åƒ</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">ç‚¹å‡»æ›´æ¢å¤´åƒ</div>
                    </div>
                    <div class="user-avatar" onclick="document.getElementById('changeAvatarInput').click()">
                        <img id="settingsAvatar" src="" alt="å¤´åƒ">
                    </div>
                    <input type="file" id="changeAvatarInput" accept="image/*" style="display: none;" onchange="changeAvatar(this)">
                </div>
                <div class="setting-item">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 5px;">æ˜µç§°</div>
                        <div style="font-size: 12px; color: var(--text-secondary);" id="settingsNickname"></div>
                    </div>
                    <button class="btn btn-primary" style="width: auto; padding: 8px 20px;" onclick="changeNickname()">ä¿®æ”¹</button>
                </div>
                <div class="setting-item">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 5px;">è´¦å·</div>
                        <div style="font-size: 12px; color: var(--text-secondary);" id="settingsUsername"></div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>ğŸ¨ ä¸»é¢˜è®¾ç½®</h3>
                <div class="setting-item">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 5px;">æ·±è‰²æ¨¡å¼</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">å¼€å¯åä½¿ç”¨æ·±è‰²ä¸»é¢˜</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-section">
                <h3>ğŸ”” é€šçŸ¥è®¾ç½®</h3>
                <div class="setting-item">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 5px;">æ¶ˆæ¯é€šçŸ¥</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">æ¥æ”¶æ–°æ¶ˆæ¯é€šçŸ¥</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" checked id="notificationToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 5px;">å£°éŸ³æç¤º</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">æ¶ˆæ¯åˆ°è¾¾æ—¶æ’­æ”¾æç¤ºéŸ³</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" checked id="soundToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-section">
                <h3>â„¹ï¸ å…³äº</h3>
                <div class="setting-item">
                    <div>ç‰ˆæœ¬ä¿¡æ¯</div>
                    <div style="color: var(--text-secondary);">v1.0.0</div>
                </div>
                <div class="setting-item">
                    <div>åœ¨çº¿ç”¨æˆ·</div>
                    <div style="color: var(--success); font-weight: 600;" id="onlineUsers">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- è§†é¢‘é€šè¯ç•Œé¢ -->
    <div class="video-call-container" id="videoCallContainer">
        <div class="video-streams">
            <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
            <video id="localVideo" class="local-video" autoplay playsinline muted></video>
        </div>
        <div class="video-controls">
            <button class="video-control-btn btn-mute" id="muteBtn" onclick="toggleMute()">ğŸ¤</button>
            <button class="video-control-btn btn-end-call" onclick="endCall()">ğŸ“µ</button>
            <button class="video-control-btn btn-mute" id="videoBtn" onclick="toggleVideo()">ğŸ“¹</button>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div class="modal" id="imageModal">
        <div class="modal-content" style="background: transparent; padding: 0;">
            <img id="modalImage" style="max-width: 100%; border-radius: 10px;" src="" alt="">
        </div>
    </div>

    <script>
        // ============= å…¨å±€å˜é‡ =============
        let currentUser = null;
        let currentChat = null;
        let currentTab = 'chat';
        let db = null;
        let peerConnection = null;
        let localStream = null;
        let ws = null;
        let momentImages = [];

        // ============= åˆå§‹åŒ– =============
        window.onload = function() {
            initDatabase();
            checkLogin();
            connectWebSocket();
        };

        // ============= æ•°æ®åº“ç®¡ç† =============
        function initDatabase() {
            // ä½¿ç”¨ IndexedDB å­˜å‚¨æ•°æ®
            const request = indexedDB.open('CloudChatDB', 1);
            
            request.onerror = function() {
                console.error('æ•°æ®åº“æ‰“å¼€å¤±è´¥');
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                console.log('æ•°æ®åº“å·²è¿æ¥');
            };
            
            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                
                // ç”¨æˆ·è¡¨
                if (!db.objectStoreNames.contains('users')) {
                    const userStore = db.createObjectStore('users', { keyPath: 'username' });
                    userStore.createIndex('nickname', 'nickname', { unique: false });
                }
                
                // æ¶ˆæ¯è¡¨
                if (!db.objectStoreNames.contains('messages')) {
                    const msgStore = db.createObjectStore('messages', { keyPath: 'id', autoIncrement: true });
                    msgStore.createIndex('chatId', 'chatId', { unique: false });
                    msgStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
                
                // å¥½å‹å…³ç³»è¡¨
                if (!db.objectStoreNames.contains('friends')) {
                    const friendStore = db.createObjectStore('friends', { keyPath: 'id', autoIncrement: true });
                    friendStore.createIndex('userId', 'userId', { unique: false });
                }
                
                // å¥½å‹è¯·æ±‚è¡¨
                if (!db.objectStoreNames.contains('friendRequests')) {
                    const reqStore = db.createObjectStore('friendRequests', { keyPath: 'id', autoIncrement: true });
                    reqStore.createIndex('toUser', 'toUser', { unique: false });
                }
                
                // åŠ¨æ€è¡¨
                if (!db.objectStoreNames.contains('moments')) {
                    const momentStore = db.createObjectStore('moments', { keyPath: 'id', autoIncrement: true });
                    momentStore.createIndex('userId', 'userId', { unique: false });
                    momentStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
        }

        // ============= WebSocketè¿æ¥ï¼ˆä½¿ç”¨å…è´¹å…¬å…±æœåŠ¡ï¼‰ =============
        function connectWebSocket() {
            // ä½¿ç”¨ PeerJS ä½œä¸ºä¿¡ä»¤æœåŠ¡å™¨ï¼ˆå…è´¹ï¼‰
            // æˆ–è€…ä½¿ç”¨ Socket.io çš„å…¬å…±æµ‹è¯•æœåŠ¡å™¨
            try {
                // è¿™é‡Œä½¿ç”¨ç®€å•çš„è½®è¯¢æœºåˆ¶æ¨¡æ‹Ÿå®æ—¶é€šä¿¡
                setInterval(syncMessages, 3000); // æ¯3ç§’åŒæ­¥ä¸€æ¬¡æ¶ˆæ¯
            } catch(e) {
                console.log('WebSocketè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
            }
        }

        // ============= ç”¨æˆ·è®¤è¯ =============
        function checkLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            }
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        // å¤´åƒé¢„è§ˆ
        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // æ³¨å†Œ
        document.getElementById('registerForm').onsubmit = function(e) {
            e.preventDefault();
            
            const username = document.getElementById('registerUsername').value.trim();
            const nickname = document.getElementById('registerNickname').value.trim();
            const password = document.getElementById('registerPassword').value;
            const avatarSrc = document.getElementById('avatarPreview').src;
            
            if (!username || !nickname || !password) {
                showNotification('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }
            
            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            const transaction = db.transaction(['users'], 'readwrite');
            const store = transaction.objectStore('users');
            const request = store.get(username);
            
            request.onsuccess = function() {
                if (request.result) {
                    showNotification('è´¦å·å·²å­˜åœ¨ï¼Œè¯·æ›´æ¢', 'error');
                } else {
                    // åˆ›å»ºæ–°ç”¨æˆ·
                    const newUser = {
                        username: username,
                        nickname: nickname,
                        password: password,
                        avatar: avatarSrc,
                        createdAt: new Date().toISOString(),
                        status: 'online'
                    };
                    
                    store.add(newUser);
                    showNotification('æ³¨å†ŒæˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        showLogin();
                    }, 1000);
                }
            };
        };

        // ç™»å½•
        document.getElementById('loginForm').onsubmit = function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const transaction = db.transaction(['users'], 'readonly');
            const store = transaction.objectStore('users');
            const request = store.get(username);
            
            request.onsuccess = function() {
                const user = request.result;
                if (user && user.password === password) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showNotification('ç™»å½•æˆåŠŸï¼', 'success');
                    setTimeout(showApp, 500);
                } else {
                    showNotification('è´¦å·æˆ–å¯†ç é”™è¯¯', 'error');
                }
            };
        };

        // æ˜¾ç¤ºåº”ç”¨
        function showApp() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('appPage').classList.add('active');
            
            // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
            document.getElementById('sidebarAvatar').src = currentUser.avatar;
            document.getElementById('settingsAvatar').src = currentUser.avatar;
            document.getElementById('settingsNickname').textContent = currentUser.nickname;
            document.getElementById('settingsUsername').textContent = currentUser.username;
            
            // åŠ è½½æ•°æ®
            loadContacts();
            loadFriendRequests();
            loadMoments();
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('currentUser');
                location.reload();
            }
        }

        // ============= æ ‡ç­¾é¡µåˆ‡æ¢ =============
        function showTab(tab) {
            currentTab = tab;
            
            // æ›´æ–°ä¾§è¾¹æ å›¾æ ‡
            document.querySelectorAll('.sidebar-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            event.target.closest('.sidebar-icon').classList.add('active');
            
            // éšè—æ‰€æœ‰é¡µé¢
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('contactsPanel').classList.remove('hidden');
            document.getElementById('momentsPage').classList.add('hidden');
            document.getElementById('friendsPage').classList.add('hidden');
            document.getElementById('settingsPage').classList.add('hidden');
            
            // æ˜¾ç¤ºå¯¹åº”é¡µé¢
            switch(tab) {
                case 'chat':
                    // èŠå¤©ç•Œé¢é»˜è®¤æ˜¾ç¤º
                    break;
                case 'moments':
                    document.getElementById('chatArea').classList.add('hidden');
                    document.getElementById('contactsPanel').classList.add('hidden');
                    document.getElementById('momentsPage').classList.remove('hidden');
                    loadMoments();
                    break;
                case 'friends':
                    document.getElementById('chatArea').classList.add('hidden');
                    document.getElementById('contactsPanel').classList.add('hidden');
                    document.getElementById('friendsPage').classList.remove('hidden');
                    loadFriendRequests();
                    break;
                case 'settings':
                    document.getElementById('chatArea').classList.add('hidden');
                    document.getElementById('contactsPanel').classList.add('hidden');
                    document.getElementById('settingsPage').classList.remove('hidden');
                    break;
            }
        }

        // ============= è”ç³»äººç®¡ç† =============
        function loadContacts() {
            const transaction = db.transaction(['friends', 'users'], 'readonly');
            const friendStore = transaction.objectStore('friends');
            const userStore = transaction.objectStore('users');
            const index = friendStore.index('userId');
            const request = index.getAll(currentUser.username);
            
            request.onsuccess = function() {
                const friends = request.result;
                const contactsList = document.getElementById('contactsList');
                contactsList.innerHTML = '';
                
                if (friends.length === 0) {
                    contactsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">æš‚æ— å¥½å‹<br>æœç´¢è´¦å·æ·»åŠ å¥½å‹å§</p>';
                    return;
                }
                
                friends.forEach(friend => {
                    const userReq = userStore.get(friend.friendId);
                    userReq.onsuccess = function() {
                        const friendUser = userReq.result;
                        if (friendUser) {
                            const unreadCount = getUnreadCount(friendUser.username);
                            contactsList.innerHTML += `
                                <div class="contact-item" onclick="openChat('${friendUser.username}')">
                                    <div class="contact-avatar">
                                        <img src="${friendUser.avatar}" alt="${friendUser.nickname}">
                                        ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                                    </div>
                                    <div class="contact-info">
                                        <div class="contact-name">${friendUser.nickname}</div>
                                        <div class="contact-message">ç‚¹å‡»å¼€å§‹èŠå¤©</div>
                                    </div>
                                </div>
                            `;
                        }
                    };
                });
            };
        }

        // æœç´¢å¹¶æ·»åŠ å¥½å‹
        function searchAndAddFriend() {
            const searchUsername = document.getElementById('searchUser').value.trim();
            if (!searchUsername) {
                showNotification('è¯·è¾“å…¥è¦æœç´¢çš„è´¦å·', 'error');
                return;
            }
            
            if (searchUsername === currentUser.username) {
                showNotification('ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºå¥½å‹', 'error');
                return;
            }
            
            const transaction = db.transaction(['users', 'friends', 'friendRequests'], 'readwrite');
            const userStore = transaction.objectStore('users');
            const friendStore = transaction.objectStore('friends');
            const requestStore = transaction.objectStore('friendRequests');
            
            const request = userStore.get(searchUsername);
            
            request.onsuccess = function() {
                const user = request.result;
                if (!user) {
                    showNotification('ç”¨æˆ·ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å¥½å‹
                const friendIndex = friendStore.index('userId');
                const friendCheck = friendIndex.getAll(currentUser.username);
                
                friendCheck.onsuccess = function() {
                    const friends = friendCheck.result;
                    const isFriend = friends.some(f => f.friendId === searchUsername);
                    
                    if (isFriend) {
                        showNotification('å·²ç»æ˜¯å¥½å‹äº†', 'info');
                        return;
                    }
                    
                    // å‘é€å¥½å‹è¯·æ±‚
                    const friendRequest = {
                        fromUser: currentUser.username,
                        fromNickname: currentUser.nickname,
                        fromAvatar: currentUser.avatar,
                        toUser: searchUsername,
                        status: 'pending',
                        timestamp: new Date().toISOString()
                    };
                    
                    requestStore.add(friendRequest);
                    showNotification('å¥½å‹è¯·æ±‚å·²å‘é€', 'success');
                    document.getElementById('searchUser').value = '';
                    
                    // å‘é€WebSocketé€šçŸ¥ï¼ˆå¦‚æœåœ¨çº¿ï¼‰
                    sendNotification(searchUsername, 'friendRequest', friendRequest);
                };
            };
        }

        // åŠ è½½å¥½å‹è¯·æ±‚
        function loadFriendRequests() {
            const transaction = db.transaction(['friendRequests'], 'readonly');
            const store = transaction.objectStore('friendRequests');
            const index = store.index('toUser');
            const request = index.getAll(currentUser.username);
            
            request.onsuccess = function() {
                const requests = request.result.filter(r => r.status === 'pending');
                const requestsList = document.getElementById('friendRequestsList');
                
                if (requests.length === 0) {
                    requestsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">æš‚æ— æ–°çš„å¥½å‹è¯·æ±‚</p>';
                    return;
                }
                
                requestsList.innerHTML = '';
                requests.forEach(req => {
                    requestsList.innerHTML += `
                        <div class="friend-request">
                            <div class="friend-request-info">
                                <div class="contact-avatar" style="margin-right: 15px;">
                                    <img src="${req.fromAvatar}" alt="${req.fromNickname}">
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${req.fromNickname}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">è´¦å·: ${req.fromUser}</div>
                                </div>
                            </div>
                            <div class="friend-request-actions">
                                <button class="btn-accept" onclick="acceptFriendRequest(${req.id})">åŒæ„</button>
                                <button class="btn-reject" onclick="rejectFriendRequest(${req.id})">æ‹’ç»</button>
                            </div>
                        </div>
                    `;
                });
            };
        }

        // æ¥å—å¥½å‹è¯·æ±‚
        function acceptFriendRequest(requestId) {
            const transaction = db.transaction(['friendRequests', 'friends'], 'readwrite');
            const requestStore = transaction.objectStore('friendRequests');
            const friendStore = transaction.objectStore('friends');
            
            const request = requestStore.get(requestId);
            
            request.onsuccess = function() {
                const friendRequest = request.result;
                
                // æ›´æ–°è¯·æ±‚çŠ¶æ€
                friendRequest.status = 'accepted';
                requestStore.put(friendRequest);
                
                // æ·»åŠ åŒå‘å¥½å‹å…³ç³»
                friendStore.add({
                    userId: currentUser.username,
                    friendId: friendRequest.fromUser,
                    addedAt: new Date().toISOString()
                });
                
                friendStore.add({
                    userId: friendRequest.fromUser,
                    friendId: currentUser.username,
                    addedAt: new Date().toISOString()
                });
                
                showNotification('å·²æ·»åŠ å¥½å‹', 'success');
                loadFriendRequests();
                loadContacts();
            };
        }

        // æ‹’ç»å¥½å‹è¯·æ±‚
        function rejectFriendRequest(requestId) {
            const transaction = db.transaction(['friendRequests'], 'readwrite');
            const store = transaction.objectStore('friendRequests');
            const request = store.get(requestId);
            
            request.onsuccess = function() {
                const friendRequest = request.result;
                friendRequest.status = 'rejected';
                store.put(friendRequest);
                
                showNotification('å·²æ‹’ç»', 'info');
                loadFriendRequests();
            };
        }

           // ============= èŠå¤©åŠŸèƒ½ =============
        function openChat(username) {
            const transaction = db.transaction(['users'], 'readonly');
            const store = transaction.objectStore('users');
            const request = store.get(username);
            
            request.onsuccess = function() {
                const user = request.result;
                currentChat = user;
                
                // æ›´æ–°èŠå¤©å¤´éƒ¨
                document.getElementById('chatAvatar').src = user.avatar;
                document.getElementById('chatName').textContent = user.nickname;
                document.getElementById('chatStatus').textContent = `è´¦å·: ${user.username}`;
                
                // åŠ è½½èŠå¤©è®°å½•
                loadMessages(username);
                
                // æ¸…é™¤æœªè¯»æ ‡è®°
                clearUnread(username);
                
                // é«˜äº®å½“å‰è”ç³»äºº
                document.querySelectorAll('.contact-item').forEach(item => {
                    item.classList.remove('active');
                });
            };
        }

        function loadMessages(username) {
            const chatId = [currentUser.username, username].sort().join('_');
            
            const transaction = db.transaction(['messages'], 'readonly');
            const store = transaction.objectStore('messages');
            const index = store.index('chatId');
            const request = index.getAll(chatId);
            
            request.onsuccess = function() {
                const messages = request.result.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">æš‚æ— èŠå¤©è®°å½•ï¼Œå‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å§ï¼</div>';
                    return;
                }
                
                messages.forEach(msg => {
                    displayMessage(msg);
                });
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };
        }

        function displayMessage(msg) {
            const chatMessages = document.getElementById('chatMessages');
            const isSent = msg.sender === currentUser.username;
            const avatar = isSent ? currentUser.avatar : currentChat.avatar;
            
            let contentHtml = '';
            if (msg.type === 'text') {
                contentHtml = `<div class="message-bubble">${escapeHtml(msg.content)}</div>`;
            } else if (msg.type === 'image') {
                contentHtml = `<img src="${msg.content}" class="message-image" onclick="showImageModal('${msg.content}')">`;
            }
            
            const messageHtml = `
                <div class="message ${isSent ? 'sent' : 'received'}">
                    <div class="message-avatar">
                        <img src="${avatar}" alt="">
                    </div>
                    <div class="message-content">
                        ${contentHtml}
                        <div class="message-time">${formatTime(msg.timestamp)}</div>
                    </div>
                </div>
            `;
            
            chatMessages.innerHTML += messageHtml;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) {
                showNotification('æ¶ˆæ¯ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            if (!currentChat) {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè”ç³»äºº', 'error');
                return;
            }
            
            const message = {
                chatId: [currentUser.username, currentChat.username].sort().join('_'),
                sender: currentUser.username,
                receiver: currentChat.username,
                type: 'text',
                content: content,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            const transaction = db.transaction(['messages'], 'readwrite');
            const store = transaction.objectStore('messages');
            store.add(message);
            
            transaction.oncomplete = function() {
                displayMessage(message);
                input.value = '';
                
                // é€šè¿‡WebSocketå‘é€ç»™å¯¹æ–¹
                sendToUser(currentChat.username, message);
                playNotificationSound();
            };
        }

        function sendImage(input) {
            if (!currentChat) {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè”ç³»äºº', 'error');
                return;
            }
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    
                    // å‹ç¼©å›¾ç‰‡
                    compressImage(imageData, function(compressed) {
                        const message = {
                            chatId: [currentUser.username, currentChat.username].sort().join('_'),
                            sender: currentUser.username,
                            receiver: currentChat.username,
                            type: 'image',
                            content: compressed,
                            timestamp: new Date().toISOString(),
                            read: false
                        };
                        
                        const transaction = db.transaction(['messages'], 'readwrite');
                        const store = transaction.objectStore('messages');
                        store.add(message);
                        
                        transaction.oncomplete = function() {
                            displayMessage(message);
                            sendToUser(currentChat.username, message);
                            playNotificationSound();
                        };
                    });
                };
                reader.readAsDataURL(input.files[0]);
            }
            
            input.value = '';
        }

        // å‹ç¼©å›¾ç‰‡
        function compressImage(src, callback) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // é™åˆ¶æœ€å¤§å°ºå¯¸
                let width = img.width;
                let height = img.height;
                const maxSize = 800;
                
                if (width > height && width > maxSize) {
                    height = (height * maxSize) / width;
                    width = maxSize;
                } else if (height > maxSize) {
                    width = (width * maxSize) / height;
                    height = maxSize;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                callback(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.src = src;
        }

        // è¡¨æƒ…é€‰æ‹©
        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('active');
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
            document.getElementById('emojiPicker').classList.remove('active');
        }

        // å›è½¦å‘é€
        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // è·å–æœªè¯»æ¶ˆæ¯æ•°
        function getUnreadCount(username) {
            // è¿™é‡Œå¯ä»¥å®ç°æœªè¯»æ¶ˆæ¯è®¡æ•°é€»è¾‘
            return 0;
        }

        // æ¸…é™¤æœªè¯»æ ‡è®°
        function clearUnread(username) {
            const chatId = [currentUser.username, username].sort().join('_');
            const transaction = db.transaction(['messages'], 'readwrite');
            const store = transaction.objectStore('messages');
            const index = store.index('chatId');
            const request = index.openCursor(IDBKeyRange.only(chatId));
            
            request.onsuccess = function(event) {
                const cursor = event.target.result;
                if (cursor) {
                    const message = cursor.value;
                    if (message.receiver === currentUser.username) {
                        message.read = true;
                        cursor.update(message);
                    }
                    cursor.continue();
                }
            };
        }

        // ============= åŠ¨æ€åŠŸèƒ½ =============
        function previewMomentImages(input) {
            const preview = document.getElementById('momentImagePreview');
            preview.innerHTML = '';
            momentImages = [];
            
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    compressImage(e.target.result, function(compressed) {
                        momentImages.push(compressed);
                        const img = document.createElement('img');
                        img.src = compressed;
                        img.style.width = '100%';
                        img.style.borderRadius = '10px';
                        preview.appendChild(img);
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        function publishMoment() {
            const text = document.getElementById('momentText').value.trim();
            
            if (!text && momentImages.length === 0) {
                showNotification('è¯·è¾“å…¥å†…å®¹æˆ–æ·»åŠ å›¾ç‰‡', 'error');
                return;
            }
            
            const moment = {
                userId: currentUser.username,
                userNickname: currentUser.nickname,
                userAvatar: currentUser.avatar,
                content: text,
                images: momentImages,
                likes: 0,
                comments: [],
                timestamp: new Date().toISOString()
            };
            
            const transaction = db.transaction(['moments'], 'readwrite');
            const store = transaction.objectStore('moments');
            store.add(moment);
            
            transaction.oncomplete = function() {
                showNotification('åŠ¨æ€å‘å¸ƒæˆåŠŸ', 'success');
                document.getElementById('momentText').value = '';
                document.getElementById('momentImagePreview').innerHTML = '';
                momentImages = [];
                document.getElementById('momentImageInput').value = '';
                loadMoments();
            };
        }

        function loadMoments() {
            const transaction = db.transaction(['moments', 'friends'], 'readonly');
            const momentStore = transaction.objectStore('moments');
            const friendStore = transaction.objectStore('friends');
            
            // è·å–å¥½å‹åˆ—è¡¨
            const friendIndex = friendStore.index('userId');
            const friendRequest = friendIndex.getAll(currentUser.username);
            
            friendRequest.onsuccess = function() {
                const friends = friendRequest.result.map(f => f.friendId);
                friends.push(currentUser.username); // åŒ…æ‹¬è‡ªå·±
                
                // è·å–æ‰€æœ‰åŠ¨æ€
                const momentRequest = momentStore.getAll();
                
                momentRequest.onsuccess = function() {
                    const allMoments = momentRequest.result;
                    // åªæ˜¾ç¤ºå¥½å‹å’Œè‡ªå·±çš„åŠ¨æ€
                    const moments = allMoments
                        .filter(m => friends.includes(m.userId))
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    const momentsList = document.getElementById('momentsList');
                    momentsList.innerHTML = '';
                    
                    if (moments.length === 0) {
                        momentsList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">æš‚æ— åŠ¨æ€</div>';
                        return;
                    }
                    
                    moments.forEach(moment => {
                        const imagesHtml = moment.images.length > 0 ? `
                            <div class="moment-images">
                                ${moment.images.map(img => `<img src="${img}" onclick="showImageModal('${img}')">`).join('')}
                            </div>
                        ` : '';
                        
                        momentsList.innerHTML += `
                            <div class="moment-card">
                                <div class="moment-header">
                                    <div class="moment-avatar">
                                        <img src="${moment.userAvatar}" alt="${moment.userNickname}">
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${moment.userNickname}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${formatTime(moment.timestamp)}</div>
                                    </div>
                                </div>
                                <div class="moment-content">${escapeHtml(moment.content)}</div>
                                ${imagesHtml}
                                <div class="moment-actions">
                                    <button class="moment-action-btn" onclick="likeMoment(${moment.id})">
                                        â¤ï¸ ${moment.likes}
                                    </button>
                                    <button class="moment-action-btn">
                                        ğŸ’¬ ${moment.comments.length}
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                };
            };
        }

        function likeMoment(momentId) {
            const transaction = db.transaction(['moments'], 'readwrite');
            const store = transaction.objectStore('moments');
            const request = store.get(momentId);
            
            request.onsuccess = function() {
                const moment = request.result;
                moment.likes++;
                store.put(moment);
                loadMoments();
            };
        }

        // ============= è§†é¢‘/è¯­éŸ³é€šè¯ =============
        async function startVideoCall() {
            if (!currentChat) {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè”ç³»äºº', 'error');
                return;
            }
            
            try {
                // è·å–æœ¬åœ°åª’ä½“æµ
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('videoCallContainer').classList.add('active');
                
                // è¿™é‡Œéœ€è¦WebRTCè¿æ¥ï¼Œä½¿ç”¨PeerJSæˆ–å…¶ä»–ä¿¡ä»¤æœåŠ¡å™¨
                showNotification('è§†é¢‘é€šè¯åŠŸèƒ½éœ€è¦é…ç½®WebRTCæœåŠ¡å™¨', 'info');
                
            } catch (err) {
                showNotification('æ— æ³•è®¿é—®æ‘„åƒå¤´å’Œéº¦å…‹é£', 'error');
                console.error(err);
            }
        }

        async function startVoiceCall() {
            if (!currentChat) {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè”ç³»äºº', 'error');
                return;
            }
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: false,
                    audio: true
                });
                
                document.getElementById('videoCallContainer').classList.add('active');
                document.getElementById('remoteVideo').style.display = 'none';
                
                showNotification('è¯­éŸ³é€šè¯åŠŸèƒ½éœ€è¦é…ç½®WebRTCæœåŠ¡å™¨', 'info');
                
            } catch (err) {
                showNotification('æ— æ³•è®¿é—®éº¦å…‹é£', 'error');
                console.error(err);
            }
        }

        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                document.getElementById('muteBtn').style.background = audioTrack.enabled ? '' : 'var(--danger)';
            }
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    document.getElementById('videoBtn').style.background = videoTrack.enabled ? '' : 'var(--danger)';
                }
            }
        }

        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            document.getElementById('videoCallContainer').classList.remove('active');
            document.getElementById('remoteVideo').style.display = 'block';
        }

        // ============= è®¾ç½®åŠŸèƒ½ =============
        function toggleDarkMode() {
            const isDark = document.getElementById('darkModeToggle').checked;
            document.body.className = isDark ? 'theme-dark' : 'theme-light';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function changeAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    compressImage(e.target.result, function(compressed) {
                        // æ›´æ–°ç”¨æˆ·å¤´åƒ
                        const transaction = db.transaction(['users'], 'readwrite');
                        const store = transaction.objectStore('users');
                        const request = store.get(currentUser.username);
                        
                        request.onsuccess = function() {
                            const user = request.result;
                            user.avatar = compressed;
                            store.put(user);
                            
                            // æ›´æ–°ç•Œé¢
                            currentUser.avatar = compressed;
                            document.getElementById('sidebarAvatar').src = compressed;
                            document.getElementById('settingsAvatar').src = compressed;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            
                            showNotification('å¤´åƒæ›´æ–°æˆåŠŸ', 'success');
                        };
                    });
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function changeNickname() {
            const newNickname = prompt('è¯·è¾“å…¥æ–°æ˜µç§°', currentUser.nickname);
            if (newNickname && newNickname.trim()) {
                const transaction = db.transaction(['users'], 'readwrite');
                const store = transaction.objectStore('users');
                const request = store.get(currentUser.username);
                
                request.onsuccess = function() {
                    const user = request.result;
                    user.nickname = newNickname.trim();
                    store.put(user);
                    
                    currentUser.nickname = newNickname.trim();
                    document.getElementById('settingsNickname').textContent = newNickname.trim();
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showNotification('æ˜µç§°æ›´æ–°æˆåŠŸ', 'success');
                };
            }
        }

        // ============= å·¥å…·å‡½æ•° =============
        function showImageModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').classList.add('active');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('imageModal').onclick = function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        };

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">
                    ${type === 'success' ? 'âœ… æˆåŠŸ' : type === 'error' ? 'âŒ é”™è¯¯' : 'â„¹ï¸ æç¤º'}
                </div>
                <div>${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
            
            return date.toLocaleDateString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function playNotificationSound() {
            if (document.getElementById('soundToggle').checked) {
                // åˆ›å»ºæç¤ºéŸ³
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }
        }

        // ============= ç½‘ç»œåŒæ­¥ï¼ˆä½¿ç”¨å…è´¹APIï¼‰ =============
        function sendToUser(username, message) {
            // è¿™é‡Œå¯ä»¥é›†æˆå…è´¹çš„å®æ—¶é€šä¿¡æœåŠ¡
            // ä¾‹å¦‚: Firebase, Supabase, PubNubç­‰
            
            // ç®€å•ç¤ºä¾‹: ä½¿ç”¨localStorageæ¨¡æ‹Ÿè·¨è®¾å¤‡é€šä¿¡
            // å®é™…éƒ¨ç½²æ—¶éœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„API
            
            const syncKey = `sync_${username}_${Date.now()}`;
            localStorage.setItem(syncKey, JSON.stringify(message));
        }

        function syncMessages() {
            // å®šæœŸæ£€æŸ¥æ–°æ¶ˆæ¯
            // å®é™…åº”ç”¨ä¸­ä½¿ç”¨WebSocketæˆ–Server-Sent Events
        }

        function sendNotification(toUser, type, data) {
            // å‘é€ç³»ç»Ÿé€šçŸ¥
            if (Notification.permission === 'granted') {
                new Notification('CloudChat', {
                    body: 'æ‚¨æœ‰æ–°æ¶ˆæ¯',
                    icon: currentUser.avatar
                });
            }
        }

        // è¯·æ±‚é€šçŸ¥æƒé™
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // åŠ è½½ä¸»é¢˜è®¾ç½®
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.className = 'theme-dark';
            document.getElementById('darkModeToggle').checked = true;
        }

        // ç‚¹å‡»ç©ºç™½å¤„å…³é—­emojié€‰æ‹©å™¨
        document.addEventListener('click', function(e) {
            const emojiPicker = document.getElementById('emojiPicker');
            const emojiBtn = document.querySelector('.tool-btn');
            if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                emojiPicker.classList.remove('active');
            }
        });
    </script>
</body>
</html>

